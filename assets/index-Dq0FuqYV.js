(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function o(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=o(s);fetch(s.href,i)}})();let X=new Map;const wo=2e3,ve=e=>{const t={x:e.position.x,y:e.position.y,rotation:e.rotation},o=e.parent;if(o==null)return t;const n=ve(o),s=Math.cos(n.rotation),i=Math.sin(n.rotation);return{x:n.x+t.x*s-t.y*i,y:n.y+t.x*i+t.y*s,rotation:n.rotation+t.rotation}},vo=(e,t)=>{X[e]||(X[e]=[]);const o=performance.now();X[e].push({x:t.x,y:t.y,time:o}),X[e]=X[e].filter(n=>o-n.time<wo)},bo=e=>{delete X[e]},Mo=()=>{X=new Map},ko=e=>{for(const t in X){const o=X[t];if(!(!o||o.length<2)){e.beginPath();for(let n=0;n<o.length;n++){const s=o[n];n===0?e.moveTo(s.x,s.y):e.lineTo(s.x,s.y)}e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=1,e.stroke()}}},Eo="/asteroid-pew-pew/img/boom/boom_0.gif",To="/asteroid-pew-pew/img/boom/boom_1.gif",Io="/asteroid-pew-pew/img/boom/boom_2.gif",Po="/asteroid-pew-pew/img/boom/boom_3.gif",Vo="/asteroid-pew-pew/img/boom/boom_4.gif",So="/asteroid-pew-pew/img/boom/boom_5.gif",No="/asteroid-pew-pew/img/boom/boom_6.gif",Lo="/asteroid-pew-pew/img/boom/boom_7.gif",Ao="/asteroid-pew-pew/img/boom/boom_8.gif",Bo="/asteroid-pew-pew/img/boom/boom_9.gif",Co="/asteroid-pew-pew/img/boom/boom_10.gif",Do="/asteroid-pew-pew/img/boom/boom_11.gif",Fo="/asteroid-pew-pew/img/boom/boom_12.gif",Uo="/asteroid-pew-pew/img/boom/boom_13.gif",Ro="/asteroid-pew-pew/img/boom/boom_14.gif",Ho="/asteroid-pew-pew/img/ice.png",Oo="/asteroid-pew-pew/img/powerup.png",Dt=5,wt=.7,Z=2;function _o(e,t,o){e.fractureSeeds=qo(Go(e,t),e.radius);const n=o?null:zo(e);e.voronoiData=jo(e,n)}function qo(e,t){const o=[];for(let n=0;n<Dt;n++){const s=Math.random()*2*Math.PI,i=Math.sqrt(Math.random())*t,d=Math.cos(s)*i,c=Math.sin(s)*i,u=wt*e.x,h=wt*e.y,g=u+d,m=h+c;g*g+m*m<=Math.pow(t,2)?o.push({x:g,y:m}):n--}return o}function Wo(e,t){const{position:o,rotation:n,fractureSeeds:s}=t,i=Math.cos(n),d=Math.sin(n);e.fillStyle="red";for(const c of s){const u={x:o.x+c.x*i-c.y*d,y:o.y+c.x*d+c.y*i};e.beginPath(),e.arc(u.x,u.y,2,0,Math.PI*2),e.fill()}}function Go(e,t){const o=t.position.x-e.position.x,n=t.position.y-e.position.y,s=Math.sin(-e.rotation),i=Math.cos(-e.rotation);return{x:o*i-n*s,y:o*s+n*i}}function jo(e,t=null){const{fractureSeeds:o,radius:n}=e,s=n*2,i=n*2,d=new Int16Array(s*i).fill(-1),c=document.createElement("canvas");c.width=s,c.height=i;const u=c.getContext("2d"),h=u.getImageData(0,0,s,i),g=h.data,m=s/2,p=i/2;for(let x=0;x<i;x++)for(let y=0;y<s;y++){const w=y-m,I=x-p;if(w*w+I*I>n*n)continue;let U=1/0,E=-1;for(let P=0;P<o.length;P++){const q=o[P];let ke=w-q.x,Ee=I-q.y;if(t){const W=t(y,x);ke+=(W-.5)*10,Ee+=(W-.5)*10}const Te=ke*ke+Ee*Ee;Te<U&&(U=Te,E=P)}d[x*s+y]=E;const T=Math.sqrt(U),M=Math.min(1,T/n),S=(x*s+y)*4,[D,$,R]=$o(M);g[S]=D,g[S+1]=$,g[S+2]=R,g[S+3]=255}return u.putImageData(h,0,0),{heatMap:c,cellMap:d}}function $o(e){if(e=Math.max(0,Math.min(1,e)),e<.33){const t=e/.33;return[255,Math.round(255*t),0]}else if(e<.66){const t=(e-.33)/.33;return[Math.round(255*(1-t)),255,0]}else{const t=(e-.66)/.34;return[0,Math.round(255*(1-t)),Math.round(255*t)]}}function zo(e){const t=e.radius*2,o=e.radius*2,n=new Float32Array(o*t),s=Math.floor(o/Z)+2,i=Math.floor(t/Z)+2,d=[];for(let u=0;u<i*s;u++)d.push(Math.random());for(let u=0;u<t;u++)for(let h=0;h<o;h++){const g=Math.floor(h/Z),m=Math.floor(u/Z),p=h%Z/Z,x=u%Z/Z,y=m*s+g,w=d[y],I=d[y+1],U=d[y+s],E=d[y+s+1],T=w*(1-p)+I*p,M=U*(1-p)+E*p;n[u*o+h]=T*(1-x)+M*x}return(u,h)=>n[h*o+u]}function Xo(e){const t=[],o=e.texture,n=e.voronoiData.cellMap,s=e.radius*2,i=e.radius*2;for(let d=0;d<Dt;d++){let c=s,u=i,h=0,g=0;for(let M=0;M<n.length;M++){if(n[M]===-1||n[M]!==d)continue;const S=M%s,D=Math.floor(M/s);c=S<c?S:c,u=D<u?D:u,h=S>h?S:h,g=D>g?D:g}const m=h-c+1,p=g-u+1,x=document.createElement("canvas");x.width=m,x.height=p;const y=x.getContext("2d"),w=y.createImageData(m,p);let I=w.data;const T=o.getContext("2d").getImageData(0,0,s,i).data;for(let M=0;M<n.length;M++){if(n[M]!==d)continue;const S=M%s,D=Math.floor(M/s),$=S-c,P=((D-u)*m+$)*4,q=M*4;I[P]=T[q],I[P+1]=T[q+1],I[P+2]=T[q+2],I[P+3]=T[q+3]}y.putImageData(w,0,0),t.push(x)}return t}const Ge=(e,t)=>e.x*t.x+e.y*t.y,se=e=>{const t=Ie(e);return{x:e.x/t,y:e.y/t}},vt=(e,t)=>({x:e.x+t.x,y:e.y+t.y}),C=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Ft=(e,t,o)=>({x:e.x+(t.x-e.x)*o,y:e.y+(t.y-e.y)*o}),Se=e=>({x:Math.cos(e),y:Math.sin(e)}),Yo=e=>{const t=Math.atan2(e.y,e.x);return t<0?t+Math.PI*2:t},Ie=e=>Math.sqrt(e.x**2+e.y**2),bt=(e,t)=>({x:t*-e.y,y:t*e.x}),Ue=(e,t)=>e.x*t.y-e.y*t.x,ce=document.getElementsByTagName("canvas")[0],r=ce.getContext("2d"),De="asteroid",Y="bullet",ye="explosion",Ne="flash",J="rocket",Fe="spaceship",Ut="velocity",xe="spaceshippart",be="flames",Ke="powerup",Me="flame_particles",Le="collision",Jo="#ffffff",Ko="#ffff00",et="#ff0000",Mt="#00ff00";let Qo=0;const Zo=()=>`${Qo++}`,K={[De]:{color:Jo},[Y]:{color:Ko,length:10,strokeWidth:2},[J]:{color:et,radius:10},[Fe]:{color:Mt},[Ut]:{color:et},[xe]:{color:Mt},[be]:{color:et},[Me]:{color:"blue"}},G={[be]:{},[Me]:{},[Fe]:{},[xe]:{},[De]:{},[Y]:{},[J]:{},[ye]:{},[Ne]:{},[Ke]:{},[Le]:{}};let Rt=!1,Ht=!1,Ot=!1,_t=!1,qt=!1,Wt=!1;const en=e=>{Rt=e},tn=e=>{Ht=e},on=e=>{Ot=e},nn=e=>{_t=e},sn=e=>{qt=e},an=e=>{Wt=e},O=(e,t)=>{t.id=Zo(),G[e][t.id]=t},F=(e,t)=>{delete G[e][t],bo(t)},rn=()=>{for(const e in G)G[e]={};Mo()},A=[];for(let e=0;e<15;++e)A.push(new Image);A[0].src=Eo;A[1].src=To;A[2].src=Io;A[3].src=Po;A[4].src=Vo;A[5].src=So;A[6].src=No;A[7].src=Lo;A[8].src=Ao;A[9].src=Bo;A[10].src=Co;A[11].src=Do;A[12].src=Fo;A[13].src=Uo;A[14].src=Ro;const Gt=new Image;Gt.src=Ho;const cn=()=>{ce.width=ce.clientWidth,ce.height=ce.clientHeight,r.clearRect(0,0,ce.width,ce.height);for(const e in G)for(const t of Object.values(G[e])){switch(e){case De:ln(t);break;case ye:mn(t);break;case Y:dn(t);break;case J:un(t);break;case Fe:case xe:hn(t);break;case be:gn(t);break;case Me:pn(t);break;case Ne:fn(t);break;case Ke:yn(t);break;case Le:xn(t);break}e!==Le&&e!==ye&&e!==Ne&&vo(t.id,ve(t))}if(Rt){r.strokeStyle=K[Ut].color,r.lineWidth=1,r.beginPath();for(const e in G){for(const t of Object.values(G[e])){if("velocity"in t){const{position:o,velocity:n}=t,{x:s,y:i}=o,{x:d,y:c}=n;r.moveTo(s,i),r.lineTo(s+d*200,i+c*200)}if("angularVelocity"in t){const{position:o,angularVelocity:n}=t,{x:s,y:i}=o;n>0?(r.moveTo(s+20,i),r.arc(s,i,20,0,n*300)):(r.moveTo(s+20*Math.cos(n*300),i+20*Math.sin(n*300)),r.arc(s,i,20,n*300,0))}}r.stroke()}}if(Ht){r.strokeStyle="cyan",r.lineWidth=1,r.beginPath();for(const e in G)for(const t of Object.values(G[e]))st(t);r.stroke()}Ot&&ko(r)},ln=e=>{const{width:t,height:o,radius:n,texture:s,textureReady:i,voronoiData:d}=e;if(!i)return;const c=ve(e);r.save(),r.translate(c.x,c.y),r.rotate(c.rotation);const u=t!=0?t:n*2,h=o!=0?o:n*2,g=Wt&&d?d.heatMap:s;r.drawImage(g,-n,-n,u,h),e.frozen&&(r.globalAlpha=.2,r.drawImage(Gt,-n-20,-n-20,u+40,h+40),r.globalAlpha=1),r.restore(),qt&&Wo(r,e)},dn=e=>{var s;const{length:t}=K[Y],o=Math.cos(e.rotation)*t/2,n=Math.sin(e.rotation)*t/2;r.fillStyle=e.friendly?K[Y].color:"red",r.strokeStyle=e.friendly?K[Y].color:"red",r.lineWidth=(s=K[Y])==null?void 0:s.strokeWidth,r.beginPath(),r.moveTo(e.position.x+o,e.position.y+n),r.lineTo(e.position.x-o,e.position.y-n),r.stroke()},un=e=>{var d;const{radius:t}=K[J],o=2*Math.PI/8,n={x:e.position.x+t*Math.cos(e.rotation),y:e.position.y+t*Math.sin(e.rotation)},s={x:e.position.x-t*Math.cos(e.rotation+o),y:e.position.y-t*Math.sin(e.rotation+o)},i={x:e.position.x-t*Math.cos(e.rotation-o),y:e.position.y-t*Math.sin(e.rotation-o)};if(r.fillStyle=K[J].color,r.strokeStyle=K[J].color,r.lineWidth=((d=K[J])==null?void 0:d.strokeWidth)??0,r.beginPath(),r.moveTo(n.x,n.y),r.lineTo(s.x,s.y),r.lineTo(i.x,i.y),r.lineTo(n.x,n.y),r.stroke(),_t){for(const c of e.targets)r.moveTo(c.position.x,c.position.y),r.arc(c.position.x,c.position.y,4,0,2*Math.PI);r.fill(),r.strokeStyle="grey",r.beginPath(),r.moveTo(e.pathPoints[0].x,e.pathPoints[0].y);for(const c of e.pathPoints)r.lineTo(c.x,c.y),r.arc(c.x,c.y,2,0,2*Math.PI),r.moveTo(c.x,c.y);r.lineTo(e.targets[e.targets.length-1].x,e.targets[e.targets.length-1].y),r.stroke()}},mn=e=>{r.translate(e.position.x,e.position.y);const n=A[e.frame];r.drawImage(n,-100/2,-100/2,100,100),r.translate(-e.position.x,-e.position.y),e.frame<A.length-1?e.frame++:F(ye,e.id)},hn=e=>{const{width:t,height:o,texture:n,textureReady:s}=e;if(!s)return;const i=ve(e);r.save(),r.translate(i.x,i.y),r.rotate(i.rotation),r.drawImage(n,-t/2,-o/2,t,o),r.restore()},gn=e=>{var h,g,m;const{width:t,height:o}=e,n=ve(e),s=((h=e==null?void 0:e.parent)==null?void 0:h.velocity)??{x:0,y:1},i=((m=(g=e==null?void 0:e.parent)==null?void 0:g.parent)==null?void 0:m.velocity)??{x:0,y:0},d={x:s.x+i.x,y:s.y+i.y},c=Math.min(Math.sqrt(d.x**2+d.y**2)*5,2);r.save(),r.translate(n.x,n.y),r.rotate(n.rotation),r.beginPath();const u=Math.random()*5;r.moveTo(0,0),r.lineTo(-t,(o+u)*c),r.lineTo(t,(o+u)*c),r.closePath(),r.fillStyle="orange",r.fill(),r.beginPath(),r.moveTo(0,0),r.lineTo(-t/2,(o/2+u)*c),r.lineTo(t/2,(o/2+u)*c),r.closePath(),r.fillStyle="yellow",r.fill(),r.restore()},pn=e=>{const{width:t,height:o}=e,n=ve(e);r.save(),r.translate(n.x,n.y),r.rotate(n.rotation);const s=5;for(let i=0;i<s;i++){const d=(Math.random()-.5)*t*2,c=Math.random()+o,u=1+Math.random()*2;r.globalAlpha=.2+Math.random()*.3,r.fillStyle="blue",r.beginPath(),r.arc(d,c,u,0,Math.PI*2),r.fill()}r.globalAlpha=1,r.restore()},fn=e=>{const t=e.position,o=e.rotation,n=3,s=15;r.fillStyle="white",r.strokeStyle="none",r.beginPath(),r.translate(t.x,t.y),r.rotate(o),r.moveTo(n,n),r.lineTo(s,0),r.lineTo(n,-3),r.lineTo(0,-15),r.lineTo(-3,-3),r.lineTo(-15,0),r.lineTo(-3,n),r.lineTo(0,s),r.resetTransform(),r.closePath(),r.fill()},jt=new Image;jt.src=Oo;const yn=e=>{const{width:t,height:o}=e,n=t/2,s=o/2;switch(r.save(),r.translate(e.position.x,e.position.y),r.rotate(e.rotation),r.drawImage(jt,-n,-s,t,o),e.type){case"health":r.textAlign="center",r.font="20px Arial",r.fillText("🧡",0,7);break;case"damage":r.fillStyle="yellow",r.textAlign="center",r.font="20px Arial",r.fillText("=",0,7);break;case"rocket-piercing":r.textAlign="center",r.font="20px Arial",r.fillText("🚀",0,7);break;default:console.warn("Unknown powerup type:",e.type)}r.restore()},Re=(e,t,o,n,s=300)=>{o>0?(r.moveTo(e+n,t),r.arc(e,t,n,0,o*s)):(r.moveTo(e+n*Math.cos(o*s),t+n*Math.sin(o*s)),r.arc(e,t,n,o*s,0))},st=e=>{switch(e.collider){case void 0:break;case"disc":r.moveTo(e.position.x+e.radius,e.position.y),r.arc(e.position.x,e.position.y,e.radius,0,2*Math.PI);break;case"box":const t=it(e);r.moveTo(t.at(-1).x,t.at(-1).y),t.forEach(o=>r.lineTo(o.x,o.y));break;default:console.warn("Unknown collider type:",e.collider)}},xn=e=>{const{a:t,b:o,collisionPoint:n,normal:s,lifetime:i}=e;if(i==0){F(Le,e.id);return}e.lifetime--,r.strokeStyle="white",r.lineWidth=1,r.beginPath(),st(t),st(o),r.stroke(),r.strokeStyle="magenta",r.lineWidth=1,r.moveTo(n.x+5,n.y),r.beginPath(),r.arc(n.x,n.y,5,0,2*Math.PI),r.moveTo(n.x,n.y),r.lineTo(n.x+s.x*20,n.y+s.y*20),r.stroke(),r.strokeStyle="red",r.beginPath(),r.moveTo(t.position.x,t.position.y),r.lineTo(t.position.x+t.oldVelocity.x*200,t.position.y+t.oldVelocity.y*200),r.moveTo(o.position.x,o.position.y),r.lineTo(o.position.x+o.oldVelocity.x*200,o.position.y+o.oldVelocity.y*200),Re(t.position.x,t.position.y,t.oldAngularVelocity,20),Re(o.position.x,o.position.y,o.oldAngularVelocity,20),r.stroke(),r.strokeStyle="green",r.beginPath(),r.moveTo(t.position.x,t.position.y),r.lineTo(t.position.x+t.newVelocity.x*200,t.position.y+t.newVelocity.y*200),r.moveTo(o.position.x,o.position.y),r.lineTo(o.position.x+o.newVelocity.x*200,o.position.y+o.newVelocity.y*200),Re(t.position.x,t.position.y,t.newAngularVelocity,25),Re(o.position.x,o.position.y,o.newAngularVelocity,25),r.stroke(),r.save()},Q="box",he="disc",re=()=>({position:{x:0,y:0},velocity:{x:0,y:0},acceleration:{x:0,y:0},force:{x:0,y:0},rotation:0,angularVelocity:0,angularAcceleration:0,torque:0,mass:1,inertia:1,radius:0,drag:1,height:0,width:0,maxVelocity:1,parent:null,texture:null,fractureSeeds:[],textureReady:!1,voronoiData:null}),kt=e=>{let t={x:0,y:0};for(const o of e)o.frozen||(t.x+=o.velocity.x*o.mass,t.y+=o.velocity.y*o.mass);if(isNaN(t.x)||isNaN(t.y)){console.warn("Total momentum is NaN",t);debugger}return Math.sqrt(t.x**2+t.y**2)},He=(e,t)=>{if(e.frozen)return;e.position.x+=e.velocity.x*t+.5*e.acceleration.x*t**2,e.position.y+=e.velocity.y*t+.5*e.acceleration.y*t**2,e.velocity.x+=e.drag*e.acceleration.x*t,e.velocity.y+=e.drag*e.acceleration.y*t,e.acceleration.x=e.force.x/e.mass,e.acceleration.y=e.force.y/e.mass,e.force.x=0,e.force.y=0,e.rotation+=e.angularVelocity*t+.5*e.angularAcceleration*t**2,e.angularVelocity+=e.angularAcceleration*t,e.angularAcceleration=e.torque/e.inertia,e.torque=0;const o=Math.sqrt(e.velocity.x**2+e.velocity.y**2);if(o>e.maxVelocity&&(e.velocity.x/=o/e.maxVelocity,e.velocity.y/=o/e.maxVelocity),isNaN(e.position.x)||isNaN(e.position.y)){console.warn("Entity position is NaN",e);debugger}},wn=(e,t)=>Math.sqrt((t.position.x-e.position.x)**2+(t.position.y-e.position.y)**2),je=(e,t)=>{const o=wn(e,t),n=e.radius+t.radius;if(o<n){const s=se(C(t.position,e.position)),i=Ft(e.position,t.position,e.radius/o),d=n-o;return{collisionPoint:i,normal:s,overlap:d}}else return null},it=e=>{const t={x:e.width/2,y:e.height/2},o=Se(e.rotation),n={x:-o.y,y:o.x};return[{x:e.position.x-t.x*o.x-t.y*n.x,y:e.position.y-t.x*o.y-t.y*n.y},{x:e.position.x+t.x*o.x-t.y*n.x,y:e.position.y+t.x*o.y-t.y*n.y},{x:e.position.x+t.x*o.x+t.y*n.x,y:e.position.y+t.x*o.y+t.y*n.y},{x:e.position.x-t.x*o.x+t.y*n.x,y:e.position.y-t.x*o.y+t.y*n.y}]},_e=(e,t)=>{const o=C(e.position,t.position),n=Math.cos(-t.rotation),s=Math.sin(-t.rotation),i={x:o.x*n-o.y*s,y:o.x*s+o.y*n},d={x:Math.max(-t.width/2,Math.min(i.x,t.width/2)),y:Math.max(-t.height/2,Math.min(i.y,t.height/2))},c=C(i,d),u=Math.sqrt(c.x*c.x+c.y*c.y);if(u<=e.radius){const h=Math.cos(t.rotation),g=Math.sin(t.rotation),m={x:t.position.x+d.x*h-d.y*g,y:t.position.y+d.x*g+d.y*h},p=se(C(e.position,m)),x=se(C(t.position,e.position));if(Ge(p,x)<0&&(p.x=-p.x,p.y=-p.y),isNaN(p.x)||isNaN(p.y))return console.warn("Collision normal is NaN",e,t,p),null;const w={x:e.position.x+p.x*e.radius,y:e.position.y+p.y*e.radius},I=e.radius-u+1e-5;return isNaN(w.x)||isNaN(w.y)?(console.warn("Collision point is NaN",e,t,w),null):{collisionPoint:w,normal:p,overlap:I}}},vn=(e,t)=>{const o=_e(t,e);return o==null?null:(o.normal.x=-o.normal.x,o.normal.y=-o.normal.y,o)},at=(e,t)=>{const o=Se(e.rotation),n={x:-o.y,y:o.x},s=Se(t.rotation),i={x:-s.y,y:s.x},d=it(e),c=it(t),u=[o,n,s,i];let h=[0,1,2,3],g=[0,1,2,3],m,p,x=1/0;for(let E=0;E<u.length;++E){const T=u[E],M=W=>Ge(W,T),S=d.map(M),D=c.map(M),$=Math.min(...S),R=Math.max(...S),P=Math.min(...D),q=Math.max(...D);if(R<P||q<$)return null;E<2?g=g.filter(W=>D[W]>=$&&D[W]<=R):h=h.filter(W=>S[W]>=P&&S[W]<=q);const ke=Math.min(R,q),Ee=Math.max($,P),Te=ke-Ee;Te<x&&(x=Te,p=T)}const y=[...h.map(E=>d[E]),...g.map(E=>c[E])];if(y.length===0)return console.warn("No corners found for collision, this should not happen",e,t),null;const w=y.reduce((E,T)=>({x:E.x+T.x,y:E.y+T.y}),{x:0,y:0});w.x/=y.length,w.y/=y.length,m=w,bn(m,p,x);const I=se(C(t.position,e.position));return Ge(p,I)<0&&(p.x=-p.x,p.y=-p.y),{collisionPoint:m,normal:p,overlap:x}},ee=e=>e.collider===Q,te=e=>e.collider===he,bn=(e,t,o)=>{if(isNaN(e.x)||isNaN(e.y)){console.warn("Collision point is NaN",a,b,e);debugger}if(isNaN(t.x)||isNaN(t.y)){console.warn("Collision normal is NaN",a,b,t);debugger}if(isNaN(o)){console.warn("Collision overlap is NaN",a,b,o);debugger}},ge=(e,t,o)=>{let n;if(ee(e)&&ee(t)?n=at(e,t):te(e)&&ee(t)?n=_e(e,t):ee(e)&&te(t)?n=vn(e,t):te(e)&&te(t)&&(n=je(e,t)),n==null)return!1;let{collisionPoint:s,normal:i,overlap:d}=n;d+=1e-5,d>10&&console.warn("Collision overlap is too large, this should not happen",e,t,d);const c=e.mass+t.mass,u=C(s,e.position),h=C(s,t.position);e.position.x-=i.x*d*t.mass/c,e.position.y-=i.y*d*t.mass/c,t.position.x+=i.x*d*e.mass/c,t.position.y+=i.y*d*e.mass/c;let g;ee(e)&&ee(t)?g=at(e,t):te(e)&&ee(t)?g=_e(e,t):ee(e)&&te(t)?g=_e(t,e):te(e)&&te(t)&&(g=je(e,t)),g!=null&&console.warn("Collision still detected after resolving overlap",e,t,g);const m=vt(e.velocity,bt(u,e.angularVelocity)),p=vt(t.velocity,bt(h,t.angularVelocity)),x=C(m,p),y=Ge(x,i),w=Ue(u,i),I=Ue(h,i),U=1/e.mass+1/t.mass+w*w/e.inertia+I*I/t.inertia,E=-2*y/U,T={x:E*i.x,y:E*i.y},M={...e.velocity},S={...t.velocity},D=e.angularVelocity,$=t.angularVelocity;if(e.frozen||(e.velocity.x+=T.x/e.mass,e.velocity.y+=T.y/e.mass,e.angularVelocity+=Ue(u,T)/e.inertia),t.frozen||(t.velocity.x-=T.x/t.mass,t.velocity.y-=T.y/t.mass,t.angularVelocity-=Ue(h,T)/t.inertia),isNaN(e.velocity.x)||isNaN(e.velocity.y)||isNaN(t.velocity.x)||isNaN(t.velocity.y)){console.warn("Entity velocity is NaN after collision resolution",e,t);debugger}if(isNaN(e.angularVelocity)||isNaN(t.angularVelocity)){console.warn("Entity angular velocity is NaN after collision resolution",e,t);debugger}const R={collider:e.collider,position:{...e.position},newVelocity:{...e.velocity},oldVelocity:M,newAngularVelocity:e.angularVelocity,oldAngularVelocity:D},P={collider:t.collider,position:{...t.position},newVelocity:{...t.velocity},oldVelocity:S,newAngularVelocity:t.angularVelocity,oldAngularVelocity:$};if(e.collider===he&&(R.radius=e.radius),t.collider===he&&(P.radius=t.radius),e.collider===Q&&(R.width=e.width,R.height=e.height,R.rotation=e.rotation),t.collider===Q&&(P.width=t.width,P.height=t.height,P.rotation=t.rotation),o(R,P,s,i,d),isNaN(e.position.x)||isNaN(e.position.y)||isNaN(t.position.x)||isNaN(t.position.y)){console.warn("Entity position is NaN after collision resolution",e,t);debugger}return!0};let $t=!1;const Mn=e=>{$t=e},kn=40,oe=.9,Et=(e,t,o,n,s)=>o+(-.9*t+oe*n)*e+(2*oe*t+(oe-3)*o+(3-2*oe)*n-oe*s)*e*e+(-.9*t+(2-oe)*o+(oe-2)*n+oe*s)*e*e*e,Pe=(e,t,o,n,s)=>({x:Et(e,t.x,o.x,n.x,s.x),y:Et(e,t.y,o.y,n.y,s.y)}),En=(e,t)=>{for(let o=0;o<e.targetCordLengths.length;++o)if(t<e.targetCordLengths[o])return o;return e.targetCordLengths.length-1},zt=(e,t)=>{t=Xt(e,t)*e.arcLengthTable.cordLength;const n=En(e,t),s=n===0?0:e.targetCordLengths[n-1],i=e.targetCordLengths[n],d=t-s,c=i-s,u=d/c;return Pe(u,e.targets[n+0].position,e.targets[n+1].position,e.targets[n+2].position,e.targets[n+3].position)},Tn=e=>{e.arcLengthTable=[],e.targetCordLengths=[],e.arcLengthTable.cordLength=0;let t=e.targets[1].position;for(let o=0;o<e.targets.length-3;++o){const n=Pe(0,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position),s=Pe(1,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position),i=Ie(C(s,n)),d=[{fromProgress:0,toProgress:1,from:n,to:s,distance:i}],c=new Set;for(c.add(0),c.add(1);d.length>0;){const{fromProgress:h,toProgress:g,from:m,to:p,distance:x}=d.pop(),y=(h+g)/2,w=Pe(y,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position),I=Ie(C(w,m)),U=Ie(C(p,w));Math.abs(I+U-x)>.01?(d.push({fromProgress:h,toProgress:y,from:m,to:w,distance:I}),d.push({fromProgress:y,toProgress:g,from:w,to:p,distance:U})):c.add(y)}const u=[...c.values()];u.sort((h,g)=>h-g);for(const h of u){const g=Pe(h,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position);e.arcLengthTable.cordLength+=Ie(C(g,t)),e.arcLengthTable.push({v:0,cordLength:e.arcLengthTable.cordLength,offset:o}),t=g}e.targetCordLengths.push(e.arcLengthTable.cordLength)}for(const o of e.arcLengthTable)o.v=o.cordLength/e.arcLengthTable.cordLength},In=e=>e*e*e,Pn=e=>e,Xt=(e,t)=>{let{v:o}=e.arcLengthTable[e.arcLengthTable.length-1];for(let n=1;n<e.arcLengthTable.length;++n){const s=e.arcLengthTable[n-1],i=e.arcLengthTable[n];if(t<i.cordLength){const d=i.cordLength-s.cordLength,u=(t-s.cordLength)/d;o=s.v*(1-u)+i.v*u;break}}return o=$t?In(o):Pn(o),o=Math.min(1,Math.max(0,o)),o},Vn=(e,t,o)=>{const n=zt(e,t);e.velocity=C(n,e.position),e.rotation=Math.atan2(e.velocity.y,e.velocity.x),e.position=n,t=Xt(e,t)*e.arcLengthTable.cordLength,t>=e.targetCordLengths[e.currentTarget]&&(o(e.targets[e.currentTarget+2]),++e.currentTarget)},Sn=e=>{e.pathPoints=[];const t=Math.ceil(e.arcLengthTable.cordLength/kn);for(let o=0;o<t;++o){const n=o/t*e.arcLengthTable.cordLength;e.pathPoints.push(zt(e,n))}e.pathPoints.push(e.targets[e.targets.length-2].position)},ne=document.getElementsByTagName("canvas")[0];let Yt=!1;const Nn=e=>{Yt=e},Jt=()=>({x:Math.random()*ne.width,y:Math.random()*ne.height}),Tt=()=>{const e=Math.floor(Math.random()*4),t=90;switch(e){case 0:return{x:Math.random()*ne.width,y:-90};case 1:return{x:ne.width+t,y:Math.random()*ne.height};case 2:return{x:Math.random()*ne.width,y:ne.height+t};case 3:return{x:-90,y:Math.random()*ne.height}}},rt=e=>(Math.random()*2-1)*e,Ln=e=>{const t=[20,30,40];return e>3e4&&(t.shift(),t.push(50)),e>6e4&&(t.shift(),t.push(60)),e>9e4&&(t.shift(),t.push(80)),e>12e4&&(t.shift(),t.push(100)),t[Math.floor(Math.random()*t.length)]},An=()=>{const e=["health","damage","rocket-piercing"],t=[.6,.9,1],o=Math.random();for(let n=0;n<e.length;n++)if(o<t[n])return e[n];return e[e.length-1]},Kt=(e,t)=>{const o=Math.random();let n=0;for(let s=0;s<t.length;s++)if(n+=t[s],o<n)return e[s];return e[t.length-1]},Bn=()=>Yt?"split":Kt(["default","split","homing","armored","turret"],[.8,.05,.05,.05,.05]),Cn=()=>Kt(["split","homing","armored","turret"],[.25,.25,.25,.25]),z={timePlayed:0,asteroidsDestroyed:0,damageDealt:0,bulletsFired:0,bulletsHit:0,rocketsFired:0,distanceTraveled:0},Dn=JSON.stringify(z),Qt=(e,t,o,n)=>"best"+(e?"-pacifist":"-default")+(t?"-stationary":"-default")+(o?"-extreme":"-default")+(n?"-hitless":"-default"),Zt=(e,t,o,n)=>{const s=Qt(e,t,o,n);return JSON.parse(localStorage.getItem(s)||Dn)},f={...z},Fn=(e,t,o,n)=>{const s=Zt(e,t,o,n);s.timePlayed=Math.max(s.timePlayed,f.timePlayed),s.asteroidsDestroyed=Math.max(s.asteroidsDestroyed,f.asteroidsDestroyed),s.damageDealt=Math.max(s.damageDealt,f.damageDealt),s.bulletsFired=Math.max(s.bulletsFired,f.bulletsFired),s.bulletsHit=Math.max(s.bulletsHit,f.bulletsHit),s.rocketsFired=Math.max(s.rocketsFired,f.rocketsFired),s.distanceTraveled=Math.max(s.distanceTraveled,f.distanceTraveled),localStorage.setItem(Qt(e,t,o),JSON.stringify(s))},Un=()=>{f.timePlayed=z.timePlayed,f.asteroidsDestroyed=z.asteroidsDestroyed,f.damageDealt=z.damageDealt,f.bulletsFired=z.bulletsFired,f.bulletsHit=z.bulletsHit,f.rocketsFired=z.rocketsFired,f.distanceTraveled=z.distanceTraveled},Rn="/asteroid-pew-pew/audio/propulsion.mp3",Hn="/asteroid-pew-pew/audio/explosion.wav",On="/asteroid-pew-pew/audio/shoot.wav",_n="/asteroid-pew-pew/audio/hurt.wav",eo="/asteroid-pew-pew/audio/hit.wav",qn="/asteroid-pew-pew/audio/click.wav",Wn="/asteroid-pew-pew/audio/submit.wav",Gn="/asteroid-pew-pew/audio/powerup.wav",jn="/asteroid-pew-pew/audio/CODEX_2015.mp3",$n="/asteroid-pew-pew/audio/armorHit.wav";let _=.1;const zn=e=>{gt.volume=.05*e,_=e},Qe=new Audio(Rn);Qe.volume=0;Qe.loop=!0;document.addEventListener("keydown",()=>Qe.play().catch(()=>{}),{once:!0});const Ze=e=>{Qe.volume=e*_},Ae=()=>{const e=new Audio(Wn);e.volume=.5*_,e.play().catch(()=>{})},N=()=>{const e=new Audio(qn);e.volume=.5*_,e.play().catch(()=>{})},Xn=()=>{const e=new Audio(eo);e.volume=.1*_,e.play().catch(()=>{})},Yn=()=>{const e=new Audio(_n);e.volume=.3*_,e.play().catch(()=>{})},to=()=>{const e=new Audio(On);e.volume=.1*_,e.play().catch(()=>{})},It=()=>{const e=new Audio(eo);e.volume=.2*_,e.play().catch(()=>{})},Jn=()=>{const e=new Audio($n);e.volume=.2*_,e.play().catch(()=>{})},qe=()=>{const e=new Audio(Hn);e.volume=.3*_,e.play().catch(()=>{})},Kn=()=>{const e=new Audio(Gn);e.volume=.2*_,e.play().catch(()=>{})},gt=new Audio(jn);gt.volume=.05*_;gt.loop=!0;const Qn="/asteroid-pew-pew/img/Asteroid1.png",Zn="/asteroid-pew-pew/img/asteroid_split.png",es="/asteroid-pew-pew/img/asteroid_red.png",ts="/asteroid-pew-pew/img/asteroid_armored.png",os="/asteroid-pew-pew/img/asteroid_green.png",ns="/asteroid-pew-pew/img/Spaceship.png",ss="/asteroid-pew-pew/img/WingLeft.png",is="/asteroid-pew-pew/img/WingRight.png";let as=document.getElementById("entity-count"),rs=document.getElementById("fps"),cs=document.getElementById("ups"),ls=document.getElementById("target-fps"),ds=document.getElementById("target-ups"),oo=document.getElementById("pause-menu");const no=document.getElementById("main-menu"),us=document.getElementById("pause-resume"),ms=document.getElementById("debug-velocity"),hs=document.getElementById("debug-hitbox"),gs=document.getElementById("debug-trajectory"),ps=document.getElementById("debug-spline-paths"),fs=document.getElementById("debug-rocket-speed"),ys=document.getElementById("debug-draw-seeds"),xs=document.getElementById("debug-draw-distance"),ws=document.getElementById("debug-disable-noise"),vs=document.getElementById("debug-split-only"),bs=document.getElementById("debug-draw-collisions"),Ms=document.getElementById("debug-box-colliders"),ks=document.getElementById("debug-easing-function-enabled");document.getElementById("fire-rate");const Es=document.getElementById("rocket-piercing"),Ts=document.getElementById("bullet-damage"),$e=document.getElementById("hp"),so=document.getElementById("game-over"),Is=document.getElementById("time-played"),Ps=document.getElementById("asteroids-destroyed"),Vs=document.getElementById("distance-traveled"),Ss=document.getElementById("damage-dealt"),Ns=document.getElementById("start"),Ls=document.getElementById("restart"),As=document.getElementById("volume"),Bs=document.getElementById("mode-pacifist"),Cs=document.getElementById("mode-stationary"),Ds=document.getElementById("mode-extreme"),Fs=document.getElementById("mode-hitless"),Us=document.getElementById("mark-pacifist"),Rs=document.getElementById("mark-stationary"),Hs=document.getElementById("mark-extreme"),Os=document.getElementById("mark-hitless"),_s=document.getElementById("back-to-main-menu"),qs=document.getElementById("pause-back-to-main-menu"),Pt=document.getElementById("controls-move"),Vt=document.getElementById("controls-bullet"),St=document.getElementById("controls-rocket"),Ws=(e,t,o,n,s,i,d,c,u,h,g,m,p)=>{Gs(e,u,t,o,h,g),$s(n,s,i,d,c,m,p),zs(e,u)},Gs=(e,t,o,n,s,i)=>{Ns.addEventListener("click",()=>{Ae(),js(),t(),e()}),Bs.addEventListener("change",d=>{N(),o(!d.target.checked),d.target.checked?(Vt.setAttribute("disabled","true"),St.setAttribute("disabled","true")):(Vt.removeAttribute("disabled"),St.removeAttribute("disabled"))}),Cs.addEventListener("change",d=>{N(),n(!d.target.checked),d.target.checked?Pt.setAttribute("disabled","true"):Pt.removeAttribute("disabled")}),Ds.addEventListener("change",d=>{N(),s(d.target.checked)}),Fs.addEventListener("change",d=>{N(),i(d.target.checked)})},io=()=>{no.style.display="grid"},js=()=>{no.style.display="none"},$s=(e,t,o,n,s,i,d)=>{As.addEventListener("input",c=>{e(c.target.value/100)}),ls.addEventListener("change",c=>{N(),c.target.value=Math.max(0,Math.min(1e3,Number(c.target.value))),t(1e3/c.target.value)}),ds.addEventListener("change",c=>{N(),c.target.value=Math.max(0,Math.min(1e3,Number(c.target.value))),o(1e3/c.target.value)}),ms.addEventListener("change",c=>{N(),en(c.target.checked)}),hs.addEventListener("change",c=>{N(),tn(c.target.checked)}),gs.addEventListener("change",c=>{N(),on(c.target.checked)}),ps.addEventListener("change",c=>{N(),nn(c.target.checked)}),ys.addEventListener("change",c=>{N(),sn(c.target.checked)}),xs.addEventListener("change",c=>{N(),an(c.target.checked)}),ws.addEventListener("change",c=>{N(),Ai(c.target.checked)}),vs.addEventListener("change",c=>{N(),Nn(c.target.checked)}),fs.addEventListener("change",c=>{N(),c.target.value=Math.max(0,Math.min(1e3,Number(c.target.value))),n(c.target.value)}),us.addEventListener("click",()=>{Ae(),ze(),s()}),qs.addEventListener("click",()=>{Ae(),ze(),io()}),bs.addEventListener("change",c=>{N(),i(c.target.checked)}),Ms.addEventListener("change",c=>{N(),d(c.target.checked)}),ks.addEventListener("change",c=>{N(),Mn(c.target.checked)})},ao=()=>{oo.style.display="grid"},ze=()=>{oo.style.display="none"},zs=(e,t)=>{Ls.addEventListener("click",()=>{Ae(),ct(),t(),e()}),_s.addEventListener("click",()=>{Ae(),ct(),io()})},Xs=()=>{so.style.display="grid"},ct=()=>{so.style.display="none"},Ys=(e,t,o,n,s,i)=>{Us.style.display=e?"none":"block",Rs.style.display=t?"none":"block",Hs.style.display=o?"block":"none",Os.style.display=n?"block":"none",Oe(Is,s.timePlayed/1e3,i.timePlayed/1e3,"s",1),Oe(Ps,s.asteroidsDestroyed,i.asteroidsDestroyed),Oe(Vs,s.distanceTraveled,i.distanceTraveled,"m",1),Oe(Ss,s.damageDealt,i.damageDealt,"hp",0)},Oe=(e,t,o,n,s)=>{e.children.item(1).innerText=n?`${t.toFixed(s)} ${n}`:`${t.toFixed(s)}`,e.children.item(2).classList.remove("new-best"),e.children.item(2).classList.remove("previous-best"),t>o?(e.children.item(2).classList.add("new-best"),e.children.item(2).innerText="New best!"):(e.children.item(2).classList.add("previous-best"),e.children.item(2).innerText=`( Best: ${n?`${o.toFixed(s)} ${n}`:o.toFixed(s)} )`)},Js=e=>{Es.innerText=`${e}`},Ks=e=>{Ts.innerText=e.toFixed(1)},pt=e=>{for(let t=0;t<$e.children.length;t++)$e.children.item(t).style.color=t<e?"red":"grey"},Qs=e=>{$e.innerHTML="";for(let t=0;t<e;t++){const o=document.createElement("li");o.innerText="❤",o.style.color="red",$e.appendChild(o)}},Zs=(e,t,o)=>{as.innerText=`${e}`,rs.innerText=`${t}`,cs.innerText=`${o}`};let B=document.getElementsByTagName("canvas")[0],we=null,ro=!1;const co=1e3,ei=1,pe=5e-4,ti=(e,t)=>{const o=t==="armored"?10:3.5;return t==="armored"?(e*2)**3*o:4/3*Math.PI*e**3*o};let k=!0;const lo=()=>k=!1;let ft,We=1e3/120;const oi=e=>We=e;let uo=1e3/60;const ni=e=>uo=e;let j=0,Xe=0,Ye=0,ie=!0;const si=e=>ie=e;let H=!0;const ii=e=>H=e;let tt=0,ot=0,Nt=0,V=[],de=[],ue=[],l=null,Ve=[],le=1,Lt=0,Be=!1,lt=0,ai=40,At=80,Je=3,Ce=!1,ri=3e3,dt=0,mo=300;const ci=e=>mo=e;let ut=1e3,mt=0;const li=e=>Math.pow(.99,e/1e3)*1e3,di={default:Qn,homing:es,armored:ts,turret:os,split:Zn};let ae=!1;const ui=e=>ae=e;let me=!1;const mi=e=>{me=e};let hi=1e4,ht=0,v={forward:!1,backward:!1,left:!1,right:!1,forwardController:!1,backwardController:!1,leftController:!1,rightController:!1},ho=!1;const gi=e=>{ho=e};let yt=!1;const pi=e=>{yt=e,V.forEach(t=>{t.collider=e?Q:he}),l&&(l.collider=e?Q:he)},fi=()=>{document.getElementById("version").innerText="0.10.0",j=performance.now(),Ye=j,xi(),Ws(Vi,si,ii,zn,ni,oi,ci,lo,Ni,ui,mi,gi,pi)},yi=e=>{if(we==null)return;const t=navigator.getGamepads()[we];t.buttons[9].value>=.5&&e-300>=Nt&&(xo(),Nt=e),t.buttons[7].pressed&&t.buttons[7].value>=.5?Be=!k&&ie:Be=!1,t.buttons[6].pressed&&t.buttons[6].value>=.5?Ce=!k&&ie:Ce=!1,t.buttons[12].pressed?v.forwardController=!k&&H:v.forwardController=!1,t.buttons[13].pressed?v.backwardController=!k&&H:v.backwardController=!1,t.buttons[14].pressed?v.leftController=!k&&H:v.leftController=!1,t.buttons[15].pressed?v.rightController=!k&&H:v.rightController=!1,(Math.abs(t.axes[2])>=.5||Math.abs(t.axes[3])>=.5)&&(l.rotation=Math.atan2(t.axes[3],t.axes[2]))},xi=()=>{for(const e of document.getElementsByClassName("controller"))e.style.display="none";window.addEventListener("gamepadconnected",e=>{we=e.gamepad.index;for(const t of document.getElementsByClassName("controller"))t.style.display="inline"}),window.addEventListener("gamepaddisconnected",()=>{we=null;for(const e of document.getElementsByClassName("controller"))e.style.display="none"}),document.addEventListener("keydown",e=>{switch(e.key){case"Escape":xo();break;case" ":Be=!k&&ie;break;case"Shift":Ce=!k&&ie;break;case"ArrowUp":case"w":case"W":v.forward=!k&&H;break;case"ArrowDown":case"s":case"S":v.backward=!k&&H;break;case"ArrowLeft":case"a":case"A":v.left=!k&&H;break;case"ArrowRight":case"d":case"D":v.right=!k&&H;break}}),document.addEventListener("keyup",e=>{switch(e.key){case" ":Be=!1;break;case"Shift":Ce=!1;break;case"ArrowUp":case"w":case"W":v.forward=!1;break;case"ArrowDown":case"s":case"S":v.backward=!1;break;case"ArrowLeft":case"a":case"A":v.left=!1;break;case"ArrowRight":case"d":case"D":v.right=!1;break}}),document.addEventListener("mousemove",e=>{if(k||l==null)return;const t=e.clientX-B.getBoundingClientRect().left,o=e.clientY-B.getBoundingClientRect().top,n=t-l.position.x,s=o-l.position.y;l.rotation=Math.atan2(s,n)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(k=!0,ao())})};let L=performance.now();const go=()=>{for(L=performance.now(),yi(L);Xe+We/2<=L;)k||(vi(We),++tt),Xe+=We;if(j+uo/2<=L&&(k||(cn(),++ot),j=L),L-Ye>=1e3){const e=V.length+de.length+ue.length+(l?1:0);Zs(e,ot,tt),ot=0,tt=0,Ye=L}ft=requestAnimationFrame(go)},wi=()=>{if(Be&&L-lt>=ai&&l){const e=l.rotation+(Math.random()-.5)*.1,t=Lt%2===0?-1:1,o=Se(l.rotation+Math.PI/2*t);o.x*=10,o.y*=10,o.x+=l.position.x,o.y+=l.position.y,fo(o,e,Se(e),0,!0),to(),Lt++,lt=L}if(Ce&&L-dt>=ri&&l){const e=[{position:{x:l.position.x-Math.cos(l.rotation)*100,y:l.position.y-Math.sin(l.rotation)*100}},{position:{x:l.position.x,y:l.position.y}}];for(let o=0;o<Math.min(Je,V.length);o++){let n;do n=V[Math.floor(Math.random()*V.length)];while(e.includes(n));n.frozen=!0,n.velocity.x=0,n.velocity.y=0,n.angularVelocity=0,n.force.x=0,n.force.y=0,n.torque=0,e.push(n)}const t=se(C(e.at(-1).position,e.at(-2).position));e.push({position:{x:e.at(-1).position.x+t.x*100,y:e.at(-1).position.y+t.y*100}}),Mi({...l.position},l.rotation,{x:0,y:0},0,e),dt=L}if(L-mt>=ut){const e=Tt(),t=Jt(),o=Math.random()*Math.PI*2,n={x:t.x-e.x,y:t.y-e.y},s=Math.sqrt(n.x**2+n.y**2);s>0&&(n.x/=s,n.y/=s),n.x*=Math.random()*.1+.1,n.y*=Math.random()*.1+.1,ae&&(n.x*=2,n.y*=2);const i=rt(5e-4),d=Ln(f.timePlayed),c=ae?Cn():Bn();po(e,o,{x:0,y:0},n,i,d,c),mt=L,ut=li(f.timePlayed)}if(L-ht>=hi){const e=Tt(),t={x:B.width/2+(Math.random()-.5)*400,y:B.height/2+(Math.random()-.5)*400},o={x:t.x-e.x,y:t.y-e.y},n=Math.sqrt(o.x**2+o.y**2);n>0&&(o.x/=n,o.y/=n),o.x*=.1,o.y*=.1;const s=rt(.005),i=An();Ti(i,e,0,o,s),ht=L}if(l){if(we!=null){const e=navigator.getGamepads()[we];let t=e.axes[1];Math.abs(e.axes[1])<=.01?t=0:e.axes[1]>=.7?t=1:e.axes[1]<=-.7&&(t=-1);let o=e.axes[0];Math.abs(e.axes[0])<=.01?o=0:e.axes[0]>=.7?o=1:e.axes[0]<=-.7&&(o=-1),l.force.y+=pe*t,l.force.x+=pe*o}l.force.x==0&&l.force.y==0&&((v.forward||v.forwardController)&&(l.force.y-=pe),(v.backward||v.backwardController)&&(l.force.y+=pe),(v.left||v.leftController)&&(l.force.x-=pe),(v.right||v.rightController)&&(l.force.x+=pe))}},nt=e=>e.x<-100||e.x>B.width+100||e.y<-100||e.y>B.height+100,Bt=()=>{l.invincible>0||(l.hp-=1,l.invincible=30,Yn(),l.hp>=0&&pt(l.hp),l.hp<=0&&(qe(),Ii(),Ze(0),O(ye,{position:{...l.position},frame:0}),setTimeout(()=>{Si()},1e3)))},vi=e=>{wi(),f.timePlayed+=e;for(let t=0;t<V.length;t++){const o=V[t];if(o.type==="homing"&&l!==null&&!o.frozen){const n=se(o.velocity),s=se(C(l.position,o.position)),i=se(Ft(n,s,.002*e)),d=Math.sqrt(o.velocity.x**2+o.velocity.y**2);let c=i.x,u=i.y;const h=Math.sqrt(c**2+u**2);if(h>0&&(c/=h,u/=h),c*=d,u*=d,o.velocity.x=c,o.velocity.y=u,isNaN(o.velocity.x)||isNaN(o.velocity.y)){console.warn("Homing asteroid velocity is NaN");debugger}}He(o,e),nt(o.position)&&(o.remove=!0);for(let n=t+1;n<V.length;n++){const s=V[n],i=kt(V);if(ge(o,s,fe)){Xn();const d=kt(V),c=Math.abs(d-i);c>1e-5&&console.warn("Momentum change after collision:",c)}}if(o.type==="turret"&&!o.frozen){const n=o.bulletIndex%5===0?At*(ae?10:50):At;if(L-o.lastBulletTime>=n){const s={x:l.position.x-o.position.x,y:l.position.y-o.position.y},i=Math.sqrt(s.x**2+s.y**2);i>0&&(s.x/=i*2,s.y/=i*2);const d={x:o.position.x,y:o.position.y};fo(d,Yo(s),s,0,!1),to(),o.lastBulletTime=L,o.bulletIndex++}}}for(const t of de)if(He(t,e),nt(t.position)&&(t.remove=!0),!t.disabled){if(t.friendly)for(const o of V)if(o.type==="armored")ge(t,o,fe)&&(f.bulletsHit++,t.velocity.x*=.1,t.velocity.y*=.1,t.disabled=!0,Jn(),setTimeout(()=>{t.remove=!0},300));else if(o.type==="split"){if(ge(t,o,fe)&&(f.bulletsHit++,f.damageDealt+=Math.min(o.hp,le),o.hp-=le,t.remove=!0,It(),_o(o,t,ro),o.hp<=0)){const n=Xo(o);++f.asteroidsDestroyed,o.remove=!0,o.hp=100,qe(),Li(n,o)}}else ge(t,o,fe)&&(f.bulletsHit++,f.damageDealt+=Math.min(o.hp,le),o.hp-=le,o.hp<=0&&(++f.asteroidsDestroyed,o.remove=!0,qe()),t.remove=!0,It());else if(ge(t,l,fe)&&(Bt(),t.remove=!0,l.hp<=0))break}for(const t of ue)t.progress+=e/1e3*mo,Vn(t,t.progress,o=>{if(o.remove=!0,++f.asteroidsDestroyed,f.damageDealt+=o.hp,qe(),t.currentTarget>=t.targets.length-4){t.remove=!0;return}});for(const t of Ve)if(He(t,e),nt(t.position)&&(t.remove=!0),at(t,l))switch(t.remove=!0,Kn(),t.type){case"health":l.hp+=1,l.hp=Math.min(l.hp,l.maxHp),pt(l.hp);break;case"damage":le+=1,Ks(le);break;case"rocket-piercing":Je+=1,Js(Je);break}if(l!==null&&l.hp>0){const t={...l.position};He(l,e);const o={x:l.position.x-t.x,y:l.position.y-t.y},n=Math.sqrt(o.x**2+o.y**2);f.distanceTraveled+=n,Ze(Math.min(n/100,.05));for(const s of V)if(ge(l,s,fe)&&(Bt(),l.hp<=0))break;l.invincible>0&&l.invincible--,l.acceleration.x===0&&l.acceleration.y===0&&(l.velocity.x*=Math.pow(.25,e/1e3),l.velocity.y*=Math.pow(.25,e/1e3)),l.angularAcceleration===0&&(l.angularVelocity*=Math.pow(.25,e/1e3))}(l.position.x<0||l.position.x>B.width)&&(l.position.x=Math.max(0,Math.min(l.position.x,B.width)),l.velocity.x*=-1),(l.position.y<0||l.position.y>B.height)&&(l.position.y=Math.max(0,Math.min(l.position.y,B.height)),l.velocity.y*=-1),bi()},bi=()=>{V.forEach(e=>{e.remove&&(F(De,e.id),e.frame=0,O(ye,e))}),de.forEach(e=>{e.remove&&F(Y,e.id)}),ue.forEach(e=>{e.remove&&(F(J,e.id),e.children.forEach(t=>{F(be,t.id);for(const o of t.children)F(Me,o.id)}))}),Ve.forEach(e=>{e.remove&&F(Ke,e.id)}),V=V.filter(e=>!e.remove),de=de.filter(e=>!e.remove),ue=ue.filter(e=>!e.remove),Ve=Ve.filter(e=>!e.remove)},po=(e,t,o,n,s,i,d,c=null,u=!1,h=0,g=0)=>{const m=re();if(m.position=e,m.rotation=t,m.acceleration=o,m.velocity=n,m.angularVelocity=s,m.mass=ti(i,d),m.radius=d==="armored"?i*2:i,m.inertia=d==="armored"?1/12*m.mass*((m.radius*2)**2+4*(m.radius*2)**2):2/5*m.mass*i**2,m.hp=i/2,m.collider=yt||h>0&&g>0||d==="armored"?Q:he,m.width=h||m.radius*2,m.height=g||m.radius*2,c?(m.texture=c,m.textureReady=!0):xt(m,di[d],m.radius*2,m.radius*2),m.type=d,d==="turret"&&(m.lastBulletTime=L,m.bulletIndex=0),!(!u&&je(m,l))){for(const p of V)if(!u&&je(m,p))return;O(De,m),V.push(m)}},fo=(e,t,o,n,s)=>{const i=re();i.position=e,i.rotation=t,i.velocity=o,i.angularVelocity=n,i.mass=co,i.collider=Q,i.width=10,i.height=1,i.inertia=i.mass*i.width/2/2,i.friendly=s,O(Y,i),de.push(i),++f.bulletsFired},Mi=(e,t,o,n,s)=>{const i=re();i.position=e,i.rotation=t,i.velocity=o,i.angularVelocity=n,i.mass=co,i.radius=5,i.targets=s,i.progress=0,i.currentTarget=0,Tn(i),Sn(i),O(J,i),ue.push(i),yo({x:-5,y:0},Math.PI/2,i),++f.rocketsFired},ki=(e,t,o,n)=>{l=re(),l.position=e,l.rotation=t,l.velocity=o,l.angularVelocity=n,l.mass=ei,l.drag=1,l.maxVelocity=.5,l.collider=yt?Q:he,l.height=40,l.width=40,l.radius=l.width/2,l.maxHp=5,me&&(l.maxHp=1),l.hp=l.maxHp,l.invincible=0,xt(l,ns,l.height,l.width),O(Fe,l),Ct({x:-5,y:18},0,xe,is,l),Ct({x:-5,y:-18},0,xe,ss,l)},Ct=(e,t,o,n,s)=>{const i=re();i.position=e,i.rotation=t,i.parent=s,i.height=20,i.width=20,O(o,i),xt(i,n,i.height,i.width),s.children??(s.children=s.children||[]),s.children.push(i),yo({x:-5,y:0},Math.PI/2,i)},yo=(e,t,o)=>{const n=re();n.position=e,n.rotation=t,n.parent=o,n.height=10,n.width=5,o.children??(o.children=o.children||[]),o.children.push(n),O(be,n),Ei({x:0,y:0},0,n)},Ei=(e,t,o)=>{const n=re();n.position=e,n.rotation=t,n.parent=o,n.height=5,n.width=5,o.children??(o.children=o.children||[]),o.children.push(n),O(Me,n)},Ti=(e,t,o,n,s)=>{if(me&&["health"].includes(e))return;const i=re();i.type=e,i.position=t,i.rotation=o,i.velocity=n,i.angularVelocity=s,i.width=50,i.height=50,i.collider=Q,O(Ke,i),Ve.push(i)},xo=()=>{k=!k,k?(ao(),Ze(0)):ze()},Ii=()=>{if(l){F(Fe,l.id);for(let e of l.children){F(xe,e.id);for(let t of e.children){F(be,t.id);for(let o of t.children)F(Me,o.id)}}}},Pi=()=>{B.width=B.clientWidth,B.height=B.clientHeight,ki({x:B.width/2,y:B.height/2},0,{x:0,y:0},0),Qs(me?1:5)},Vi=()=>{Pi(),lo(),ft=requestAnimationFrame(go)},Si=()=>{if(k)return;k=!0,cancelAnimationFrame(ft),Ze(0),l=null;const e=Zt(!ie,!H,ae,me);Ys(ie,H,ae,me,f,e),Xs(),Fn(!ie,!H,ae,me)},Ni=()=>{Xe=performance.now(),j=Xe,Ye=j,mt=j,lt=j,dt=j,ht=j,Un(),rn(),V=[],de=[],ue=[],ut=1e3,Je=3,le=1,pt(5),ze(),ct()},xt=(e,t,o,n)=>{const s=new Image;s.src=t,s.onload=()=>{const i=document.createElement("canvas");i.width=n,i.height=o,i.getContext("2d").drawImage(s,0,0,n,o),e.texture=i,e.textureReady=!0}},Li=(e,t)=>{for(let o=0;o<e.length;o++){const n=e[o],s=t.position,i={x:s.x+Math.random(),y:s.y+Math.random()},d=Jt(),c=t.rotation,u={x:d.x-i.x,y:d.y-i.y},h=Math.sqrt(u.x**2+u.y**2);h>0&&(u.x/=h,u.y/=h),u.x*=Math.random()*.1+.1,u.y*=Math.random()*.1+.1,ae&&(u.x*=2,u.y*=2);const g=rt(5e-4),m=Math.max(n.width,n.height)/2;po(i,c,{x:0,y:0},u,g,m,"default",n,!0,n.width,n.height)}},Ai=e=>{ro=e},fe=(e,t,o,n,s)=>{if(ho)O(Le,{a:e,b:t,collisionPoint:o,normal:n,lifetime:100});else{const i={position:o,rotation:Math.random()*Math.PI*2};O(Ne,i),setTimeout(()=>F(Ne,i.id),100)}};fi();
