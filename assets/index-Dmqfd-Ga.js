(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();let se=new Map;const xo=2e3,ve=e=>{const t={x:e.position.x,y:e.position.y,rotation:e.rotation},o=e.parent;if(o==null)return t;const s=ve(o),n=Math.cos(s.rotation),i=Math.sin(s.rotation);return{x:s.x+t.x*n-t.y*i,y:s.y+t.x*i+t.y*n,rotation:s.rotation+t.rotation}},wo=(e,t)=>{se[e]||(se[e]=[]);const o=performance.now();se[e].push({x:t.x,y:t.y,time:o}),se[e]=se[e].filter(s=>o-s.time<xo)},vo=e=>{delete se[e]},Mo=e=>{for(const t in se){const o=se[t];if(!(!o||o.length<2)){e.beginPath();for(let s=0;s<o.length;s++){const n=o[s];s===0?e.moveTo(n.x,n.y):e.lineTo(n.x,n.y)}e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=1,e.stroke()}}},bo="/asteroid-pew-pew/img/boom/boom_0.gif",ko="/asteroid-pew-pew/img/boom/boom_1.gif",To="/asteroid-pew-pew/img/boom/boom_2.gif",Eo="/asteroid-pew-pew/img/boom/boom_3.gif",Io="/asteroid-pew-pew/img/boom/boom_4.gif",Po="/asteroid-pew-pew/img/boom/boom_5.gif",Vo="/asteroid-pew-pew/img/boom/boom_6.gif",So="/asteroid-pew-pew/img/boom/boom_7.gif",No="/asteroid-pew-pew/img/boom/boom_8.gif",Ao="/asteroid-pew-pew/img/boom/boom_9.gif",Lo="/asteroid-pew-pew/img/boom/boom_10.gif",Bo="/asteroid-pew-pew/img/boom/boom_11.gif",Co="/asteroid-pew-pew/img/boom/boom_12.gif",Do="/asteroid-pew-pew/img/boom/boom_13.gif",Fo="/asteroid-pew-pew/img/boom/boom_14.gif",Uo="/asteroid-pew-pew/img/ice.png",Ro="/asteroid-pew-pew/img/powerup.png",Dt=5,wt=.7,Q=2;function Ho(e,t,o){e.fractureSeeds=Oo(qo(e,t),e.radius);const s=o?null:$o(e);e.voronoiData=Wo(e,s)}function Oo(e,t){const o=[];for(let s=0;s<Dt;s++){const n=Math.random()*2*Math.PI,i=Math.sqrt(Math.random())*t,d=Math.cos(n)*i,c=Math.sin(n)*i,m=wt*e.x,u=wt*e.y,g=m+d,h=u+c;g*g+h*h<=Math.pow(t,2)?o.push({x:g,y:h}):s--}return o}function _o(e,t){const{position:o,rotation:s,fractureSeeds:n}=t,i=Math.cos(s),d=Math.sin(s);e.fillStyle="red";for(const c of n){const m={x:o.x+c.x*i-c.y*d,y:o.y+c.x*d+c.y*i};e.beginPath(),e.arc(m.x,m.y,2,0,Math.PI*2),e.fill()}}function qo(e,t){const o=t.position.x-e.position.x,s=t.position.y-e.position.y,n=Math.sin(-e.rotation),i=Math.cos(-e.rotation);return{x:o*i-s*n,y:o*n+s*i}}function Wo(e,t=null){const{fractureSeeds:o,radius:s}=e,n=s*2,i=s*2,d=new Int16Array(n*i).fill(-1),c=document.createElement("canvas");c.width=n,c.height=i;const m=c.getContext("2d"),u=m.getImageData(0,0,n,i),g=u.data,h=n/2,p=i/2;for(let x=0;x<i;x++)for(let y=0;y<n;y++){const w=y-h,I=x-p;if(w*w+I*I>s*s)continue;let F=1/0,T=-1;for(let P=0;P<o.length;P++){const _=o[P];let be=w-_.x,ke=I-_.y;if(t){const W=t(y,x);be+=(W-.5)*10,ke+=(W-.5)*10}const Te=be*be+ke*ke;Te<F&&(F=Te,T=P)}d[x*n+y]=T;const E=Math.sqrt(F),M=Math.min(1,E/s),S=(x*n+y)*4,[C,j,U]=Go(M);g[S]=C,g[S+1]=j,g[S+2]=U,g[S+3]=255}return m.putImageData(u,0,0),{heatMap:c,cellMap:d}}function Go(e){if(e=Math.max(0,Math.min(1,e)),e<.33){const t=e/.33;return[255,Math.round(255*t),0]}else if(e<.66){const t=(e-.33)/.33;return[Math.round(255*(1-t)),255,0]}else{const t=(e-.66)/.34;return[0,Math.round(255*(1-t)),Math.round(255*t)]}}function $o(e){const t=e.radius*2,o=e.radius*2,s=new Float32Array(o*t),n=Math.floor(o/Q)+2,i=Math.floor(t/Q)+2,d=[];for(let m=0;m<i*n;m++)d.push(Math.random());for(let m=0;m<t;m++)for(let u=0;u<o;u++){const g=Math.floor(u/Q),h=Math.floor(m/Q),p=u%Q/Q,x=m%Q/Q,y=h*n+g,w=d[y],I=d[y+1],F=d[y+n],T=d[y+n+1],E=w*(1-p)+I*p,M=F*(1-p)+T*p;s[m*o+u]=E*(1-x)+M*x}return(m,u)=>s[u*o+m]}function jo(e){const t=[],o=e.texture,s=e.voronoiData.cellMap,n=e.radius*2,i=e.radius*2;for(let d=0;d<Dt;d++){let c=n,m=i,u=0,g=0;for(let M=0;M<s.length;M++){if(s[M]===-1||s[M]!==d)continue;const S=M%n,C=Math.floor(M/n);c=S<c?S:c,m=C<m?C:m,u=S>u?S:u,g=C>g?C:g}const h=u-c+1,p=g-m+1,x=document.createElement("canvas");x.width=h,x.height=p;const y=x.getContext("2d"),w=y.createImageData(h,p);let I=w.data;const E=o.getContext("2d").getImageData(0,0,n,i).data;for(let M=0;M<s.length;M++){if(s[M]!==d)continue;const S=M%n,C=Math.floor(M/n),j=S-c,P=((C-m)*h+j)*4,_=M*4;I[P]=E[_],I[P+1]=E[_+1],I[P+2]=E[_+2],I[P+3]=E[_+3]}y.putImageData(w,0,0),t.push(x)}return t}const We=(e,t)=>e.x*t.x+e.y*t.y,ce=e=>{const t=Ee(e);return{x:e.x/t,y:e.y/t}},vt=(e,t)=>({x:e.x+t.x,y:e.y+t.y}),D=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Ft=(e,t,o)=>({x:e.x+(t.x-e.x)*o,y:e.y+(t.y-e.y)*o}),Ve=e=>({x:Math.cos(e),y:Math.sin(e)}),zo=e=>{const t=Math.atan2(e.y,e.x);return t<0?t+Math.PI*2:t},Ee=e=>Math.sqrt(e.x**2+e.y**2),Mt=(e,t)=>({x:t*-e.y,y:t*e.x}),Fe=(e,t)=>e.x*t.y-e.y*t.x,ae=document.getElementsByTagName("canvas")[0],r=ae.getContext("2d"),Ce="asteroid",X="bullet",ye="explosion",Se="flash",Y="rocket",De="spaceship",Ut="velocity",xe="spaceshippart",Me="flames",Je="powerup",Ke="flame_particles",Ne="collision",Xo="#ffffff",Yo="#ffff00",et="#ff0000",bt="#00ff00";let Jo=0;const Ko=()=>`${Jo++}`,J={[Ce]:{color:Xo},[X]:{color:Yo,length:10,strokeWidth:2},[Y]:{color:et,radius:10},[De]:{color:bt},[Ut]:{color:et},[xe]:{color:bt},[Me]:{color:et},[Ke]:{color:"blue"}},G={[Me]:{},[Ke]:{},[De]:{},[xe]:{},[Ce]:{},[X]:{},[Y]:{},[ye]:{},[Se]:{},[Je]:{},[Ne]:{}};let Rt=!1,Ht=!1,Ot=!1,_t=!1,qt=!1,Wt=!1;const Qo=e=>{Rt=e},Zo=e=>{Ht=e},es=e=>{Ot=e},ts=e=>{_t=e},os=e=>{qt=e},ss=e=>{Wt=e},H=(e,t)=>{t.id=Ko(),G[e][t.id]=t},q=(e,t)=>{delete G[e][t],vo(t)},ns=()=>{for(const e in G)G[e]={}},A=[];for(let e=0;e<15;++e)A.push(new Image);A[0].src=bo;A[1].src=ko;A[2].src=To;A[3].src=Eo;A[4].src=Io;A[5].src=Po;A[6].src=Vo;A[7].src=So;A[8].src=No;A[9].src=Ao;A[10].src=Lo;A[11].src=Bo;A[12].src=Co;A[13].src=Do;A[14].src=Fo;const Gt=new Image;Gt.src=Uo;const is=()=>{ae.width=ae.clientWidth,ae.height=ae.clientHeight,r.clearRect(0,0,ae.width,ae.height);for(const e in G)for(const t of Object.values(G[e])){switch(e){case Ce:as(t);break;case ye:ls(t);break;case X:rs(t);break;case Y:cs(t);break;case De:case xe:ds(t);break;case Me:ms(t);break;case Ke:us(t);break;case Se:hs(t);break;case Je:gs(t);break;case Ne:ps(t);break}e!==Ne&&e!==ye&&e!==Se&&wo(t.id,ve(t))}if(Rt){r.strokeStyle=J[Ut].color,r.lineWidth=1,r.beginPath();for(const e in G){for(const t of Object.values(G[e])){if("velocity"in t){const{position:o,velocity:s}=t,{x:n,y:i}=o,{x:d,y:c}=s;r.moveTo(n,i),r.lineTo(n+d*200,i+c*200)}if("angularVelocity"in t){const{position:o,angularVelocity:s}=t,{x:n,y:i}=o;s>0?(r.moveTo(n+20,i),r.arc(n,i,20,0,s*300)):(r.moveTo(n+20*Math.cos(s*300),i+20*Math.sin(s*300)),r.arc(n,i,20,s*300,0))}}r.stroke()}}if(Ht){r.strokeStyle="cyan",r.lineWidth=1,r.beginPath();for(const e in G)for(const t of Object.values(G[e]))nt(t);r.stroke()}Ot&&Mo(r)},as=e=>{const{width:t,height:o,radius:s,texture:n,textureReady:i,voronoiData:d}=e;if(!i)return;const c=ve(e);r.save(),r.translate(c.x,c.y),r.rotate(c.rotation);const m=t!=0?t:s*2,u=o!=0?o:s*2,g=Wt&&d?d.heatMap:n;r.drawImage(g,-s,-s,m,u),e.frozen&&(r.globalAlpha=.2,r.drawImage(Gt,-s-20,-s-20,m+40,u+40),r.globalAlpha=1),r.restore(),qt&&_o(r,e)},rs=e=>{var n;const{length:t}=J[X],o=Math.cos(e.rotation)*t/2,s=Math.sin(e.rotation)*t/2;r.fillStyle=e.friendly?J[X].color:"red",r.strokeStyle=e.friendly?J[X].color:"red",r.lineWidth=(n=J[X])==null?void 0:n.strokeWidth,r.beginPath(),r.moveTo(e.position.x+o,e.position.y+s),r.lineTo(e.position.x-o,e.position.y-s),r.stroke()},cs=e=>{var d;const{radius:t}=J[Y],o=2*Math.PI/8,s={x:e.position.x+t*Math.cos(e.rotation),y:e.position.y+t*Math.sin(e.rotation)},n={x:e.position.x-t*Math.cos(e.rotation+o),y:e.position.y-t*Math.sin(e.rotation+o)},i={x:e.position.x-t*Math.cos(e.rotation-o),y:e.position.y-t*Math.sin(e.rotation-o)};if(r.fillStyle=J[Y].color,r.strokeStyle=J[Y].color,r.lineWidth=((d=J[Y])==null?void 0:d.strokeWidth)??0,r.beginPath(),r.moveTo(s.x,s.y),r.lineTo(n.x,n.y),r.lineTo(i.x,i.y),r.lineTo(s.x,s.y),r.stroke(),_t){for(const c of e.targets)r.moveTo(c.position.x,c.position.y),r.arc(c.position.x,c.position.y,4,0,2*Math.PI);r.fill(),r.strokeStyle="grey",r.beginPath(),r.moveTo(e.pathPoints[0].x,e.pathPoints[0].y);for(const c of e.pathPoints)r.lineTo(c.x,c.y),r.arc(c.x,c.y,2,0,2*Math.PI),r.moveTo(c.x,c.y);r.lineTo(e.targets[e.targets.length-1].x,e.targets[e.targets.length-1].y),r.stroke()}},ls=e=>{r.translate(e.position.x,e.position.y);const s=A[e.frame];r.drawImage(s,-100/2,-100/2,100,100),r.translate(-e.position.x,-e.position.y),e.frame<A.length-1?e.frame++:q(ye,e.id)},ds=e=>{const{width:t,height:o,texture:s,textureReady:n}=e;if(!n)return;const i=ve(e);r.save(),r.translate(i.x,i.y),r.rotate(i.rotation),r.drawImage(s,-t/2,-o/2,t,o),r.restore()},ms=e=>{var u,g,h;const{width:t,height:o}=e,s=ve(e),n=((u=e==null?void 0:e.parent)==null?void 0:u.velocity)??{x:0,y:1},i=((h=(g=e==null?void 0:e.parent)==null?void 0:g.parent)==null?void 0:h.velocity)??{x:0,y:0},d={x:n.x+i.x,y:n.y+i.y},c=Math.min(Math.sqrt(d.x**2+d.y**2)*5,2);r.save(),r.translate(s.x,s.y),r.rotate(s.rotation),r.beginPath();const m=Math.random()*5;r.moveTo(0,0),r.lineTo(-t,(o+m)*c),r.lineTo(t,(o+m)*c),r.closePath(),r.fillStyle="orange",r.fill(),r.beginPath(),r.moveTo(0,0),r.lineTo(-t/2,(o/2+m)*c),r.lineTo(t/2,(o/2+m)*c),r.closePath(),r.fillStyle="yellow",r.fill(),r.restore()},us=e=>{const{width:t,height:o}=e,s=ve(e);r.save(),r.translate(s.x,s.y),r.rotate(s.rotation);const n=5;for(let i=0;i<n;i++){const d=(Math.random()-.5)*t*2,c=Math.random()+o,m=1+Math.random()*2;r.globalAlpha=.2+Math.random()*.3,r.fillStyle="blue",r.beginPath(),r.arc(d,c,m,0,Math.PI*2),r.fill()}r.globalAlpha=1,r.restore()},hs=e=>{const t=e.position,o=e.rotation,s=3,n=15;r.fillStyle="white",r.strokeStyle="none",r.beginPath(),r.translate(t.x,t.y),r.rotate(o),r.moveTo(s,s),r.lineTo(n,0),r.lineTo(s,-3),r.lineTo(0,-15),r.lineTo(-3,-3),r.lineTo(-15,0),r.lineTo(-3,s),r.lineTo(0,n),r.resetTransform(),r.closePath(),r.fill()},$t=new Image;$t.src=Ro;const gs=e=>{const{width:t,height:o}=e,s=t/2,n=o/2;switch(r.save(),r.translate(e.position.x,e.position.y),r.rotate(e.rotation),r.drawImage($t,-s,-n,t,o),e.type){case"health":r.textAlign="center",r.font="20px Arial",r.fillText("🧡",0,7);break;case"damage":r.fillStyle="yellow",r.textAlign="center",r.font="20px Arial",r.fillText("=",0,7);break;case"rocket-piercing":r.textAlign="center",r.font="20px Arial",r.fillText("🚀",0,7);break;default:console.warn("Unknown powerup type:",e.type)}r.restore()},Ue=(e,t,o,s,n=300)=>{o>0?(r.moveTo(e+s,t),r.arc(e,t,s,0,o*n)):(r.moveTo(e+s*Math.cos(o*n),t+s*Math.sin(o*n)),r.arc(e,t,s,o*n,0))},nt=e=>{switch(e.collider){case void 0:break;case"disc":r.moveTo(e.position.x+e.radius,e.position.y),r.arc(e.position.x,e.position.y,e.radius,0,2*Math.PI);break;case"box":const t=it(e);r.moveTo(t.at(-1).x,t.at(-1).y),t.forEach(o=>r.lineTo(o.x,o.y));break;default:console.warn("Unknown collider type:",e.collider)}},ps=e=>{const{a:t,b:o,collisionPoint:s,normal:n,lifetime:i}=e;if(i==0){q(Ne,e.id);return}e.lifetime--,r.strokeStyle="white",r.lineWidth=1,r.beginPath(),nt(t),nt(o),r.stroke(),r.strokeStyle="magenta",r.lineWidth=1,r.moveTo(s.x+5,s.y),r.beginPath(),r.arc(s.x,s.y,5,0,2*Math.PI),r.moveTo(s.x,s.y),r.lineTo(s.x+n.x*20,s.y+n.y*20),r.stroke(),r.strokeStyle="red",r.beginPath(),r.moveTo(t.position.x,t.position.y),r.lineTo(t.position.x+t.oldVelocity.x*200,t.position.y+t.oldVelocity.y*200),r.moveTo(o.position.x,o.position.y),r.lineTo(o.position.x+o.oldVelocity.x*200,o.position.y+o.oldVelocity.y*200),Ue(t.position.x,t.position.y,t.oldAngularVelocity,20),Ue(o.position.x,o.position.y,o.oldAngularVelocity,20),r.stroke(),r.strokeStyle="green",r.beginPath(),r.moveTo(t.position.x,t.position.y),r.lineTo(t.position.x+t.newVelocity.x*200,t.position.y+t.newVelocity.y*200),r.moveTo(o.position.x,o.position.y),r.lineTo(o.position.x+o.newVelocity.x*200,o.position.y+o.newVelocity.y*200),Ue(t.position.x,t.position.y,t.newAngularVelocity,25),Ue(o.position.x,o.position.y,o.newAngularVelocity,25),r.stroke(),r.save()},K="box",he="disc",ie=()=>({position:{x:0,y:0},velocity:{x:0,y:0},acceleration:{x:0,y:0},force:{x:0,y:0},rotation:0,angularVelocity:0,angularAcceleration:0,torque:0,mass:1,inertia:1,radius:0,drag:1,height:0,width:0,maxVelocity:1,parent:null,texture:null,fractureSeeds:[],textureReady:!1,voronoiData:null}),kt=e=>{let t={x:0,y:0};for(const o of e)o.frozen||(t.x+=o.velocity.x*o.mass,t.y+=o.velocity.y*o.mass);if(isNaN(t.x)||isNaN(t.y)){console.warn("Total momentum is NaN",t);debugger}return Math.sqrt(t.x**2+t.y**2)},Re=(e,t)=>{if(e.frozen)return;e.position.x+=e.velocity.x*t+.5*e.acceleration.x*t**2,e.position.y+=e.velocity.y*t+.5*e.acceleration.y*t**2,e.velocity.x+=e.drag*e.acceleration.x*t,e.velocity.y+=e.drag*e.acceleration.y*t,e.acceleration.x=e.force.x/e.mass,e.acceleration.y=e.force.y/e.mass,e.force.x=0,e.force.y=0,e.rotation+=e.angularVelocity*t+.5*e.angularAcceleration*t**2,e.angularVelocity+=e.angularAcceleration*t,e.angularAcceleration=e.torque/e.inertia,e.torque=0;const o=Math.sqrt(e.velocity.x**2+e.velocity.y**2);if(o>e.maxVelocity&&(e.velocity.x/=o/e.maxVelocity,e.velocity.y/=o/e.maxVelocity),isNaN(e.position.x)||isNaN(e.position.y)){console.warn("Entity position is NaN",e);debugger}},fs=(e,t)=>Math.sqrt((t.position.x-e.position.x)**2+(t.position.y-e.position.y)**2),Ge=(e,t)=>{const o=fs(e,t),s=e.radius+t.radius;if(o<s){const n=ce(D(t.position,e.position)),i=Ft(e.position,t.position,e.radius/o),d=s-o;return{collisionPoint:i,normal:n,overlap:d}}else return null},it=e=>{const t={x:e.width/2,y:e.height/2},o=Ve(e.rotation),s={x:-o.y,y:o.x};return[{x:e.position.x-t.x*o.x-t.y*s.x,y:e.position.y-t.x*o.y-t.y*s.y},{x:e.position.x+t.x*o.x-t.y*s.x,y:e.position.y+t.x*o.y-t.y*s.y},{x:e.position.x+t.x*o.x+t.y*s.x,y:e.position.y+t.x*o.y+t.y*s.y},{x:e.position.x-t.x*o.x+t.y*s.x,y:e.position.y-t.x*o.y+t.y*s.y}]},Oe=(e,t)=>{const o=D(e.position,t.position),s=Math.cos(-t.rotation),n=Math.sin(-t.rotation),i={x:o.x*s-o.y*n,y:o.x*n+o.y*s},d={x:Math.max(-t.width/2,Math.min(i.x,t.width/2)),y:Math.max(-t.height/2,Math.min(i.y,t.height/2))},c=D(i,d),m=Math.sqrt(c.x*c.x+c.y*c.y);if(m<=e.radius){const u=Math.cos(t.rotation),g=Math.sin(t.rotation),h={x:t.position.x+d.x*u-d.y*g,y:t.position.y+d.x*g+d.y*u},p=ce(D(e.position,h)),x=ce(D(t.position,e.position));if(We(p,x)<0&&(p.x=-p.x,p.y=-p.y),isNaN(p.x)||isNaN(p.y))return console.warn("Collision normal is NaN",e,t,p),null;const w={x:e.position.x+p.x*e.radius,y:e.position.y+p.y*e.radius},I=e.radius-m+1e-5;return isNaN(w.x)||isNaN(w.y)?(console.warn("Collision point is NaN",e,t,w),null):{collisionPoint:w,normal:p,overlap:I}}},ys=(e,t)=>{const o=Oe(t,e);return o==null?null:(o.normal.x=-o.normal.x,o.normal.y=-o.normal.y,o)},at=(e,t)=>{const o=Ve(e.rotation),s={x:-o.y,y:o.x},n=Ve(t.rotation),i={x:-n.y,y:n.x},d=it(e),c=it(t),m=[o,s,n,i];let u=[0,1,2,3],g=[0,1,2,3],h,p,x=1/0;for(let T=0;T<m.length;++T){const E=m[T],M=W=>We(W,E),S=d.map(M),C=c.map(M),j=Math.min(...S),U=Math.max(...S),P=Math.min(...C),_=Math.max(...C);if(U<P||_<j)return null;T<2?g=g.filter(W=>C[W]>=j&&C[W]<=U):u=u.filter(W=>S[W]>=P&&S[W]<=_);const be=Math.min(U,_),ke=Math.max(j,P),Te=be-ke;Te<x&&(x=Te,p=E)}const y=[...u.map(T=>d[T]),...g.map(T=>c[T])];if(y.length===0)return console.warn("No corners found for collision, this should not happen",e,t),null;const w=y.reduce((T,E)=>({x:T.x+E.x,y:T.y+E.y}),{x:0,y:0});w.x/=y.length,w.y/=y.length,h=w,xs(h,p,x);const I=ce(D(t.position,e.position));return We(p,I)<0&&(p.x=-p.x,p.y=-p.y),{collisionPoint:h,normal:p,overlap:x}},Z=e=>e.collider===K,ee=e=>e.collider===he,xs=(e,t,o)=>{if(isNaN(e.x)||isNaN(e.y)){console.warn("Collision point is NaN",a,b,e);debugger}if(isNaN(t.x)||isNaN(t.y)){console.warn("Collision normal is NaN",a,b,t);debugger}if(isNaN(o)){console.warn("Collision overlap is NaN",a,b,o);debugger}},ge=(e,t,o)=>{let s;if(Z(e)&&Z(t)?s=at(e,t):ee(e)&&Z(t)?s=Oe(e,t):Z(e)&&ee(t)?s=ys(e,t):ee(e)&&ee(t)&&(s=Ge(e,t)),s==null)return!1;let{collisionPoint:n,normal:i,overlap:d}=s;d+=1e-5,d>10&&console.warn("Collision overlap is too large, this should not happen",e,t,d);const c=e.mass+t.mass,m=D(n,e.position),u=D(n,t.position);e.position.x-=i.x*d*t.mass/c,e.position.y-=i.y*d*t.mass/c,t.position.x+=i.x*d*e.mass/c,t.position.y+=i.y*d*e.mass/c;let g;Z(e)&&Z(t)?g=at(e,t):ee(e)&&Z(t)?g=Oe(e,t):Z(e)&&ee(t)?g=Oe(t,e):ee(e)&&ee(t)&&(g=Ge(e,t)),g!=null&&console.warn("Collision still detected after resolving overlap",e,t,g);const h=vt(e.velocity,Mt(m,e.angularVelocity)),p=vt(t.velocity,Mt(u,t.angularVelocity)),x=D(h,p),y=We(x,i),w=Fe(m,i),I=Fe(u,i),F=1/e.mass+1/t.mass+w*w/e.inertia+I*I/t.inertia,T=-2*y/F,E={x:T*i.x,y:T*i.y},M={...e.velocity},S={...t.velocity},C=e.angularVelocity,j=t.angularVelocity;if(e.frozen||(e.velocity.x+=E.x/e.mass,e.velocity.y+=E.y/e.mass,e.angularVelocity+=Fe(m,E)/e.inertia),t.frozen||(t.velocity.x-=E.x/t.mass,t.velocity.y-=E.y/t.mass,t.angularVelocity-=Fe(u,E)/t.inertia),isNaN(e.velocity.x)||isNaN(e.velocity.y)||isNaN(t.velocity.x)||isNaN(t.velocity.y)){console.warn("Entity velocity is NaN after collision resolution",e,t);debugger}if(isNaN(e.angularVelocity)||isNaN(t.angularVelocity)){console.warn("Entity angular velocity is NaN after collision resolution",e,t);debugger}const U={collider:e.collider,position:{...e.position},newVelocity:{...e.velocity},oldVelocity:M,newAngularVelocity:e.angularVelocity,oldAngularVelocity:C},P={collider:t.collider,position:{...t.position},newVelocity:{...t.velocity},oldVelocity:S,newAngularVelocity:t.angularVelocity,oldAngularVelocity:j};if(e.collider===he&&(U.radius=e.radius),t.collider===he&&(P.radius=t.radius),e.collider===K&&(U.width=e.width,U.height=e.height,U.rotation=e.rotation),t.collider===K&&(P.width=t.width,P.height=t.height,P.rotation=t.rotation),o(U,P,n,i,d),isNaN(e.position.x)||isNaN(e.position.y)||isNaN(t.position.x)||isNaN(t.position.y)){console.warn("Entity position is NaN after collision resolution",e,t);debugger}return!0},ws=40,te=.9,Tt=(e,t,o,s,n)=>o+(-.9*t+te*s)*e+(2*te*t+(te-3)*o+(3-2*te)*s-te*n)*e*e+(-.9*t+(2-te)*o+(te-2)*s+te*n)*e*e*e,Ie=(e,t,o,s,n)=>({x:Tt(e,t.x,o.x,s.x,n.x),y:Tt(e,t.y,o.y,s.y,n.y)}),jt=(e,t)=>{const{v:o,offset:s}=zt(e,t);t=o*e.arcLengthTable.cordLength;const n=s===0?0:e.targetCordLengths[s-1],i=e.targetCordLengths[s],d=t-n,c=i-n,m=d/c;return Ie(m,e.targets[s+0].position,e.targets[s+1].position,e.targets[s+2].position,e.targets[s+3].position)},vs=e=>{e.arcLengthTable=[],e.targetCordLengths=[],e.arcLengthTable.cordLength=0;let t=e.targets[1].position;for(let o=0;o<e.targets.length-3;++o){const s=Ie(0,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position),n=Ie(1,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position),i=Ee(D(n,s)),d=[{fromProgress:0,toProgress:1,from:s,to:n,distance:i}],c=new Set;for(c.add(0),c.add(1);d.length>0;){const{fromProgress:u,toProgress:g,from:h,to:p,distance:x}=d.pop(),y=(u+g)/2,w=Ie(y,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position),I=Ee(D(w,h)),F=Ee(D(p,w));Math.abs(I+F-x)>.01?(d.push({fromProgress:u,toProgress:y,from:h,to:w,distance:I}),d.push({fromProgress:y,toProgress:g,from:w,to:p,distance:F})):c.add(y)}const m=[...c.values()];m.sort((u,g)=>u-g);for(const u of m){const g=Ie(u,e.targets[o+0].position,e.targets[o+1].position,e.targets[o+2].position,e.targets[o+3].position);e.arcLengthTable.cordLength+=Ee(D(g,t)),e.arcLengthTable.push({v:0,cordLength:e.arcLengthTable.cordLength,offset:o}),t=g}e.targetCordLengths.push(e.arcLengthTable.cordLength)}for(const o of e.arcLengthTable)o.v=o.cordLength/e.arcLengthTable.cordLength},Ms=e=>e,zt=(e,t)=>{let{v:o,offset:s}=e.arcLengthTable[e.arcLengthTable.length-1];for(let n=1;n<e.arcLengthTable.length;++n){const i=e.arcLengthTable[n-1],d=e.arcLengthTable[n];if(t<d.cordLength){const c=d.cordLength-i.cordLength,u=(t-i.cordLength)/c;o=i.v*(1-u)+d.v*u,s=d.offset;break}}return o=Ms(o),o=Math.min(1,Math.max(0,o)),{v:o,offset:s}},bs=(e,t,o)=>{const s=jt(e,t);e.velocity=D(s,e.position),e.rotation=Math.atan2(e.velocity.y,e.velocity.x),e.position=s;const{v:n}=zt(e,t);t=n*e.arcLengthTable.cordLength,t>=e.targetCordLengths[e.currentTarget]&&(o(e.targets[e.currentTarget+2]),++e.currentTarget)},ks=e=>{e.pathPoints=[];const t=Math.ceil(e.arcLengthTable.cordLength/ws);for(let o=0;o<t;++o){const s=o/t*e.arcLengthTable.cordLength;e.pathPoints.push(jt(e,s))}e.pathPoints.push(e.targets[e.targets.length-2].position)},oe=document.getElementsByTagName("canvas")[0];let Xt=!1;const Ts=e=>{Xt=e},Yt=()=>({x:Math.random()*oe.width,y:Math.random()*oe.height}),Et=()=>{const e=Math.floor(Math.random()*4),t=90;switch(e){case 0:return{x:Math.random()*oe.width,y:-90};case 1:return{x:oe.width+t,y:Math.random()*oe.height};case 2:return{x:Math.random()*oe.width,y:oe.height+t};case 3:return{x:-90,y:Math.random()*oe.height}}},rt=e=>(Math.random()*2-1)*e,Es=e=>{const t=[20,30,40];return e>3e4&&(t.shift(),t.push(50)),e>6e4&&(t.shift(),t.push(60)),e>9e4&&(t.shift(),t.push(80)),e>12e4&&(t.shift(),t.push(100)),t[Math.floor(Math.random()*t.length)]},Is=()=>{const e=["health","damage","rocket-piercing"],t=[.6,.9,1],o=Math.random();for(let s=0;s<e.length;s++)if(o<t[s])return e[s];return e[e.length-1]},Jt=(e,t)=>{const o=Math.random();let s=0;for(let n=0;n<t.length;n++)if(s+=t[n],o<s)return e[n];return e[t.length-1]},Ps=()=>Xt?"split":Jt(["default","split","homing","armored","turret"],[.8,.05,.05,.05,.05]),Vs=()=>Jt(["split","homing","armored","turret"],[.25,.25,.25,.25]),z={timePlayed:0,asteroidsDestroyed:0,damageDealt:0,bulletsFired:0,bulletsHit:0,rocketsFired:0,distanceTraveled:0},Ss=JSON.stringify(z),Kt=(e,t,o,s)=>"best"+(e?"-pacifist":"-default")+(t?"-stationary":"-default")+(o?"-extreme":"-default")+(s?"-hitless":"-default"),Qt=(e,t,o,s)=>{const n=Kt(e,t,o,s);return JSON.parse(localStorage.getItem(n)||Ss)},f={...z},Ns=(e,t,o,s)=>{const n=Qt(e,t,o,s);n.timePlayed=Math.max(n.timePlayed,f.timePlayed),n.asteroidsDestroyed=Math.max(n.asteroidsDestroyed,f.asteroidsDestroyed),n.damageDealt=Math.max(n.damageDealt,f.damageDealt),n.bulletsFired=Math.max(n.bulletsFired,f.bulletsFired),n.bulletsHit=Math.max(n.bulletsHit,f.bulletsHit),n.rocketsFired=Math.max(n.rocketsFired,f.rocketsFired),n.distanceTraveled=Math.max(n.distanceTraveled,f.distanceTraveled),localStorage.setItem(Kt(e,t,o),JSON.stringify(n))},As=()=>{f.timePlayed=z.timePlayed,f.asteroidsDestroyed=z.asteroidsDestroyed,f.damageDealt=z.damageDealt,f.bulletsFired=z.bulletsFired,f.bulletsHit=z.bulletsHit,f.rocketsFired=z.rocketsFired,f.distanceTraveled=z.distanceTraveled},Ls="/asteroid-pew-pew/audio/propulsion.mp3",Bs="/asteroid-pew-pew/audio/explosion.wav",Cs="/asteroid-pew-pew/audio/shoot.wav",Ds="/asteroid-pew-pew/audio/hurt.wav",Zt="/asteroid-pew-pew/audio/hit.wav",Fs="/asteroid-pew-pew/audio/click.wav",Us="/asteroid-pew-pew/audio/submit.wav",Rs="/asteroid-pew-pew/audio/powerup.wav",Hs="/asteroid-pew-pew/audio/CODEX_2015.mp3",Os="/asteroid-pew-pew/audio/armorHit.wav";let O=.5;const _s=e=>{gt.volume=.05*e,O=e},Qe=new Audio(Ls);Qe.volume=0;Qe.loop=!0;document.addEventListener("keydown",()=>Qe.play().catch(()=>{}),{once:!0});const Ze=e=>{Qe.volume=e*O},Ae=()=>{const e=new Audio(Us);e.volume=.5*O,e.play().catch(()=>{})},L=()=>{const e=new Audio(Fs);e.volume=.5*O,e.play().catch(()=>{})},qs=()=>{const e=new Audio(Zt);e.volume=.1*O,e.play().catch(()=>{})},Ws=()=>{const e=new Audio(Ds);e.volume=.3*O,e.play().catch(()=>{})},eo=()=>{const e=new Audio(Cs);e.volume=.1*O,e.play().catch(()=>{})},It=()=>{const e=new Audio(Zt);e.volume=.2*O,e.play().catch(()=>{})},Gs=()=>{const e=new Audio(Os);e.volume=.2*O,e.play().catch(()=>{})},_e=()=>{const e=new Audio(Bs);e.volume=.3*O,e.play().catch(()=>{})},$s=()=>{const e=new Audio(Rs);e.volume=.2*O,e.play().catch(()=>{})},gt=new Audio(Hs);gt.volume=.05*O;gt.loop=!0;const js="/asteroid-pew-pew/img/Asteroid1.png",zs="/asteroid-pew-pew/img/asteroid_split.png",Xs="/asteroid-pew-pew/img/asteroid_red.png",Ys="/asteroid-pew-pew/img/asteroid_armored.png",Js="/asteroid-pew-pew/img/asteroid_green.png",Ks="/asteroid-pew-pew/img/Spaceship.png",Qs="/asteroid-pew-pew/img/WingLeft.png",Zs="/asteroid-pew-pew/img/WingRight.png";let en=document.getElementById("entity-count"),tn=document.getElementById("fps"),on=document.getElementById("ups"),sn=document.getElementById("target-fps"),nn=document.getElementById("target-ups"),to=document.getElementById("pause-menu");const oo=document.getElementById("main-menu"),an=document.getElementById("pause-resume"),rn=document.getElementById("debug-velocity"),cn=document.getElementById("debug-hitbox"),ln=document.getElementById("debug-trajectory"),dn=document.getElementById("debug-spline-paths"),mn=document.getElementById("debug-rocket-speed"),un=document.getElementById("debug-draw-seeds"),hn=document.getElementById("debug-draw-distance"),gn=document.getElementById("debug-disable-noise"),pn=document.getElementById("debug-split-only"),fn=document.getElementById("debug-draw-collisions"),yn=document.getElementById("debug-box-colliders");document.getElementById("fire-rate");const xn=document.getElementById("rocket-piercing"),wn=document.getElementById("bullet-damage"),$e=document.getElementById("hp"),so=document.getElementById("game-over"),vn=document.getElementById("time-played"),Mn=document.getElementById("asteroids-destroyed"),bn=document.getElementById("distance-traveled"),kn=document.getElementById("damage-dealt"),Tn=document.getElementById("start"),En=document.getElementById("restart"),In=document.getElementById("volume"),Pn=document.getElementById("mode-pacifist"),Vn=document.getElementById("mode-stationary"),Sn=document.getElementById("mode-extreme"),Nn=document.getElementById("mode-hitless"),An=document.getElementById("mark-pacifist"),Ln=document.getElementById("mark-stationary"),Bn=document.getElementById("mark-extreme"),Cn=document.getElementById("mark-hitless"),Dn=document.getElementById("back-to-main-menu"),Fn=document.getElementById("pause-back-to-main-menu"),Pt=document.getElementById("controls-move"),Vt=document.getElementById("controls-bullet"),St=document.getElementById("controls-rocket"),Un=(e,t,o,s,n,i,d,c,m,u,g,h,p)=>{Rn(e,m,t,o,u,g),On(s,n,i,d,c,h,p),_n(e,m)},Rn=(e,t,o,s,n,i)=>{Tn.addEventListener("click",()=>{Ae(),Hn(),t(),e()}),Pn.addEventListener("change",d=>{L(),o(!d.target.checked),d.target.checked?(Vt.setAttribute("disabled","true"),St.setAttribute("disabled","true")):(Vt.removeAttribute("disabled"),St.removeAttribute("disabled"))}),Vn.addEventListener("change",d=>{L(),s(!d.target.checked),d.target.checked?Pt.setAttribute("disabled","true"):Pt.removeAttribute("disabled")}),Sn.addEventListener("change",d=>{L(),n(d.target.checked)}),Nn.addEventListener("change",d=>{L(),i(d.target.checked)})},no=()=>{oo.style.display="grid"},Hn=()=>{oo.style.display="none"},On=(e,t,o,s,n,i,d)=>{In.addEventListener("input",c=>{e(c.target.value/100)}),sn.addEventListener("change",c=>{L(),c.target.value=Math.max(0,Math.min(1e3,Number(c.target.value))),t(1e3/c.target.value)}),nn.addEventListener("change",c=>{L(),c.target.value=Math.max(0,Math.min(1e3,Number(c.target.value))),o(1e3/c.target.value)}),rn.addEventListener("change",c=>{L(),Qo(c.target.checked)}),cn.addEventListener("change",c=>{L(),Zo(c.target.checked)}),ln.addEventListener("change",c=>{L(),es(c.target.checked)}),dn.addEventListener("change",c=>{L(),ts(c.target.checked)}),un.addEventListener("change",c=>{L(),os(c.target.checked)}),hn.addEventListener("change",c=>{L(),ss(c.target.checked)}),gn.addEventListener("change",c=>{L(),Ii(c.target.checked)}),pn.addEventListener("change",c=>{L(),Ts(c.target.checked)}),mn.addEventListener("change",c=>{L(),c.target.value=Math.max(0,Math.min(1e3,Number(c.target.value))),s(c.target.value)}),an.addEventListener("click",()=>{Ae(),je(),n()}),Fn.addEventListener("click",()=>{Ae(),je(),no()}),fn.addEventListener("change",c=>{L(),i(c.target.checked)}),yn.addEventListener("change",c=>{L(),d(c.target.checked)})},io=()=>{to.style.display="flex"},je=()=>{to.style.display="none"},_n=(e,t)=>{En.addEventListener("click",()=>{Ae(),ct(),t(),e()}),Dn.addEventListener("click",()=>{Ae(),ct(),no()})},qn=()=>{so.style.display="grid"},ct=()=>{so.style.display="none"},Wn=(e,t,o,s,n,i)=>{An.style.display=e?"none":"block",Ln.style.display=t?"none":"block",Bn.style.display=o?"block":"none",Cn.style.display=s?"block":"none",He(vn,n.timePlayed/1e3,i.timePlayed/1e3,"s",1),He(Mn,n.asteroidsDestroyed,i.asteroidsDestroyed),He(bn,n.distanceTraveled,i.distanceTraveled,"m",1),He(kn,n.damageDealt,i.damageDealt,"hp",0)},He=(e,t,o,s,n)=>{e.children.item(1).innerText=s?`${t.toFixed(n)} ${s}`:`${t.toFixed(n)}`,e.children.item(2).classList.remove("new-best"),e.children.item(2).classList.remove("previous-best"),t>o?(e.children.item(2).classList.add("new-best"),e.children.item(2).innerText="New best!"):(e.children.item(2).classList.add("previous-best"),e.children.item(2).innerText=`( Best: ${s?`${o.toFixed(n)} ${s}`:o.toFixed(n)} )`)},Gn=e=>{xn.innerText=`${e}`},$n=e=>{wn.innerText=e.toFixed(1)},pt=e=>{for(let t=0;t<$e.children.length;t++)$e.children.item(t).style.color=t<e?"red":"grey"},jn=e=>{$e.innerHTML="";for(let t=0;t<e;t++){const o=document.createElement("li");o.innerText="❤",o.style.color="red",$e.appendChild(o)}},zn=(e,t,o)=>{en.innerText=`${e}`,tn.innerText=`${t}`,on.innerText=`${o}`};let B=document.getElementsByTagName("canvas")[0],we=null,ao=!1;const ro=1e3,Xn=1,pe=5e-4,Yn=(e,t)=>{const o=t==="armored"?4:3.5;return 4/3*Math.PI*e**3*o};let k=!0;const co=()=>k=!1;let ft,qe=1e3/120;const Jn=e=>qe=e;let lo=1e3/60;const Kn=e=>lo=e;let $=0,ze=0,Xe=0,ne=!0;const Qn=e=>ne=e;let R=!0;const Zn=e=>R=e;let tt=0,ot=0,Nt=0,V=[],le=[],de=[],l=null,Pe=[],re=1,At=0,Le=!1,lt=0,ei=40,Lt=80,Ye=3,Be=!1,ti=3e3,dt=0,mo=300;const oi=e=>mo=e;let mt=1e3,ut=0;const si=e=>Math.pow(.99,e/1e3)*1e3,ni={default:js,homing:Xs,armored:Ys,turret:Js,split:zs};let me=!1;const ii=e=>me=e;let ue=!1;const ai=e=>{ue=e};let ri=1e4,ht=0,v={forward:!1,backward:!1,left:!1,right:!1,forwardController:!1,backwardController:!1,leftController:!1,rightController:!1},uo=!1;const ci=e=>{uo=e};let yt=!1;const li=e=>{yt=e,V.forEach(t=>{t.collider=e?K:he}),l&&(l.collider=e?K:he)},di=()=>{document.getElementById("version").innerText="0.9.0",$=performance.now(),Xe=$,ui(),Un(bi,Qn,Zn,_s,Kn,Jn,oi,co,Ti,ii,ai,ci,li)},mi=e=>{if(we==null)return;const t=navigator.getGamepads()[we];t.buttons[9].value>=.5&&e-300>=Nt&&(yo(),Nt=e),t.buttons[7].pressed&&t.buttons[7].value>=.5?Le=!k&&ne:Le=!1,t.buttons[6].pressed&&t.buttons[6].value>=.5?Be=!k&&ne:Be=!1,t.buttons[12].pressed?v.forwardController=!k&&R:v.forwardController=!1,t.buttons[13].pressed?v.backwardController=!k&&R:v.backwardController=!1,t.buttons[14].pressed?v.leftController=!k&&R:v.leftController=!1,t.buttons[15].pressed?v.rightController=!k&&R:v.rightController=!1,(Math.abs(t.axes[2])>=.5||Math.abs(t.axes[3])>=.5)&&(l.rotation=Math.atan2(t.axes[3],t.axes[2]))},ui=()=>{for(const e of document.getElementsByClassName("controller"))e.style.display="none";window.addEventListener("gamepadconnected",e=>{we=e.gamepad.index;for(const t of document.getElementsByClassName("controller"))t.style.display="inline"}),window.addEventListener("gamepaddisconnected",()=>{we=null;for(const e of document.getElementsByClassName("controller"))e.style.display="none"}),document.addEventListener("keydown",e=>{switch(e.key){case"Escape":yo();break;case" ":Le=!k&&ne;break;case"Shift":Be=!k&&ne;break;case"ArrowUp":case"w":case"W":v.forward=!k&&R;break;case"ArrowDown":case"s":case"S":v.backward=!k&&R;break;case"ArrowLeft":case"a":case"A":v.left=!k&&R;break;case"ArrowRight":case"d":case"D":v.right=!k&&R;break}}),document.addEventListener("keyup",e=>{switch(e.key){case" ":Le=!1;break;case"Shift":Be=!1;break;case"ArrowUp":case"w":case"W":v.forward=!1;break;case"ArrowDown":case"s":case"S":v.backward=!1;break;case"ArrowLeft":case"a":case"A":v.left=!1;break;case"ArrowRight":case"d":case"D":v.right=!1;break}}),document.addEventListener("mousemove",e=>{if(k||l==null)return;const t=e.clientX-B.getBoundingClientRect().left,o=e.clientY-B.getBoundingClientRect().top,s=t-l.position.x,n=o-l.position.y;l.rotation=Math.atan2(n,s)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(k=!0,io())})};let N=performance.now();const ho=()=>{for(N=performance.now(),mi(N);ze+qe/2<=N;)k||(gi(qe),++tt),ze+=qe;if($+lo/2<=N&&(k||(is(),++ot),$=N),N-Xe>=1e3){const e=V.length+le.length+de.length+(l?1:0);zn(e,ot,tt),ot=0,tt=0,Xe=N}ft=requestAnimationFrame(ho)},hi=()=>{if(Le&&N-lt>=ei&&l){const e=l.rotation+(Math.random()-.5)*.1,t=At%2===0?-1:1,o=Ve(l.rotation+Math.PI/2*t);o.x*=10,o.y*=10,o.x+=l.position.x,o.y+=l.position.y,po(o,e,Ve(e),0,!0),eo(),At++,lt=N}if(Be&&N-dt>=ti&&l){const e=[{position:{x:l.position.x-Math.cos(l.rotation)*1e3,y:l.position.y-Math.sin(l.rotation)*1e3}},{position:{x:l.position.x,y:l.position.y}}];for(let t=0;t<Math.min(Ye,V.length);t++){let o;do o=V[Math.floor(Math.random()*V.length)];while(e.includes(o));o.frozen=!0,o.velocity.x=0,o.velocity.y=0,o.angularVelocity=0,o.force.x=0,o.force.y=0,o.torque=0,e.push(o)}e.push(e.at(-1)),fi({...l.position},l.rotation,{x:0,y:0},0,e),dt=N}if(N-ut>=mt){const e=Et(),t=Yt(),o=Math.random()*Math.PI*2,s={x:t.x-e.x,y:t.y-e.y},n=Math.sqrt(s.x**2+s.y**2);n>0&&(s.x/=n,s.y/=n),s.x*=Math.random()*.1+.1,s.y*=Math.random()*.1+.1,me&&(s.x*=2,s.y*=2);const i=rt(5e-4),d=Es(f.timePlayed),c=me?Vs():Ps();go(e,o,{x:0,y:0},s,i,d,c),ut=N,mt=si(f.timePlayed)}if(N-ht>=ri){const e=Et(),t={x:B.width/2+(Math.random()-.5)*400,y:B.height/2+(Math.random()-.5)*400},o={x:t.x-e.x,y:t.y-e.y},s=Math.sqrt(o.x**2+o.y**2);s>0&&(o.x/=s,o.y/=s),o.x*=.1,o.y*=.1;const n=rt(.005),i=Is();wi(i,e,0,o,n),ht=N}if(l){if(we!=null){const e=navigator.getGamepads()[we];let t=e.axes[1];Math.abs(e.axes[1])<=.01?t=0:e.axes[1]>=.7?t=1:e.axes[1]<=-.7&&(t=-1);let o=e.axes[0];Math.abs(e.axes[0])<=.01?o=0:e.axes[0]>=.7?o=1:e.axes[0]<=-.7&&(o=-1),l.force.y+=pe*t,l.force.x+=pe*o}l.force.x==0&&l.force.y==0&&((v.forward||v.forwardController)&&(l.force.y-=pe),(v.backward||v.backwardController)&&(l.force.y+=pe),(v.left||v.leftController)&&(l.force.x-=pe),(v.right||v.rightController)&&(l.force.x+=pe))}},st=e=>e.x<-100||e.x>B.width+100||e.y<-100||e.y>B.height+100,Bt=()=>{l.invincible>0||(l.hp-=1,l.invincible=120,Ws(),l.hp>=0&&pt(l.hp),l.hp<=0&&(_e(),vi(),Ze(0),H(ye,{position:{...l.position},frame:0}),setTimeout(()=>{ki()},1e3)))},gi=e=>{hi(),f.timePlayed+=e;for(let t=0;t<V.length;t++){const o=V[t];if(o.type==="homing"&&l!==null&&!o.frozen){const s=ce(o.velocity),n=ce(D(l.position,o.position)),i=ce(Ft(s,n,.002*e)),d=Math.sqrt(o.velocity.x**2+o.velocity.y**2);let c=i.x,m=i.y;const u=Math.sqrt(c**2+m**2);if(u>0&&(c/=u,m/=u),c*=d,m*=d,o.velocity.x=c,o.velocity.y=m,isNaN(o.velocity.x)||isNaN(o.velocity.y)){console.warn("Homing asteroid velocity is NaN");debugger}}Re(o,e),st(o.position)&&(o.remove=!0);for(let s=t+1;s<V.length;s++){const n=V[s],i=kt(V);if(ge(o,n,fe)){qs();const d=kt(V),c=Math.abs(d-i);c>1e-5&&console.warn("Momentum change after collision:",c)}}if(o.type==="turret"&&!o.frozen){const s=o.bulletIndex%5===0?Lt*50:Lt;if(N-o.lastBulletTime>=s){const n={x:l.position.x-o.position.x,y:l.position.y-o.position.y},i=Math.sqrt(n.x**2+n.y**2);i>0&&(n.x/=i*2,n.y/=i*2);const d={x:o.position.x,y:o.position.y};po(d,zo(n),n,0,!1),eo(),o.lastBulletTime=N,o.bulletIndex++}}}for(const t of le)if(Re(t,e),st(t.position)&&(t.remove=!0),!t.disabled){if(t.friendly)for(const o of V)if(o.type==="armored")ge(t,o,fe)&&(f.bulletsHit++,t.velocity.x*=.1,t.velocity.y*=.1,t.disabled=!0,Gs(),setTimeout(()=>{t.remove=!0},300));else if(o.type==="split"){if(ge(t,o,fe)&&(f.bulletsHit++,f.damageDealt+=Math.min(o.hp,re),o.hp-=re,t.remove=!0,It(),Ho(o,t,ao),o.hp<=0)){const s=jo(o);++f.asteroidsDestroyed,o.remove=!0,o.hp=100,_e(),Ei(s,o)}}else ge(t,o,fe)&&(f.bulletsHit++,f.damageDealt+=Math.min(o.hp,re),o.hp-=re,o.hp<=0&&(++f.asteroidsDestroyed,o.remove=!0,_e()),t.remove=!0,It());else if(ge(t,l,fe)&&(Bt(),t.remove=!0,l.hp<=0))break}for(const t of de)t.progress+=e/1e3*mo,bs(t,t.progress,o=>{if(o.remove=!0,++f.asteroidsDestroyed,f.damageDealt+=o.hp,_e(),t.currentTarget>=t.targets.length-4){t.remove=!0;return}});for(const t of Pe)if(Re(t,e),st(t.position)&&(t.remove=!0),at(t,l))switch(t.remove=!0,$s(),t.type){case"health":l.hp+=1,l.hp=Math.min(l.hp,l.maxHp),pt(l.hp);break;case"damage":re+=1,$n(re);break;case"rocket-piercing":Ye+=1,Gn(Ye);break}if(l!==null&&l.hp>0){const t={...l.position};Re(l,e);const o={x:l.position.x-t.x,y:l.position.y-t.y},s=Math.sqrt(o.x**2+o.y**2);f.distanceTraveled+=s,Ze(Math.min(s/100,.05));for(const n of V)if(ge(l,n,fe)&&(Bt(),l.hp<=0))break;l.invincible>0&&l.invincible--,l.acceleration.x===0&&l.acceleration.y===0&&(l.velocity.x*=Math.pow(.25,e/1e3),l.velocity.y*=Math.pow(.25,e/1e3)),l.angularAcceleration===0&&(l.angularVelocity*=Math.pow(.25,e/1e3))}(l.position.x<0||l.position.x>B.width)&&(l.position.x=Math.max(0,Math.min(l.position.x,B.width)),l.velocity.x*=-1),(l.position.y<0||l.position.y>B.height)&&(l.position.y=Math.max(0,Math.min(l.position.y,B.height)),l.velocity.y*=-1),pi()},pi=()=>{V.forEach(e=>{e.remove&&(q(Ce,e.id),e.frame=0,H(ye,e))}),le.forEach(e=>{e.remove&&q(X,e.id)}),de.forEach(e=>{e.remove&&(q(Y,e.id),e.children.forEach(t=>{q(Me,t.id)}))}),Pe.forEach(e=>{e.remove&&q(Je,e.id)}),V=V.filter(e=>!e.remove),le=le.filter(e=>!e.remove),de=de.filter(e=>!e.remove),Pe=Pe.filter(e=>!e.remove)},go=(e,t,o,s,n,i,d,c=null,m=!1,u=0,g=0)=>{const h=ie();if(h.position=e,h.rotation=t,h.acceleration=o,h.velocity=s,h.angularVelocity=n,h.mass=Yn(i,d),h.radius=d==="armored"?i*2:i,h.inertia=2/5*h.mass*i**2,h.hp=i/2,h.collider=yt||u>0&&g>0||d==="armored"?K:he,h.width=u||h.radius*2,h.height=g||h.radius*2,c?(h.texture=c,h.textureReady=!0):xt(h,ni[d],h.radius*2,h.radius*2),h.type=d,d==="turret"&&(h.lastBulletTime=N,h.bulletIndex=0),!(!m&&Ge(h,l))){for(const p of V)if(!m&&Ge(h,p))return;H(Ce,h),V.push(h)}},po=(e,t,o,s,n)=>{const i=ie();i.position=e,i.rotation=t,i.velocity=o,i.angularVelocity=s,i.mass=ro,i.collider=K,i.width=10,i.height=1,i.inertia=i.mass*i.width/2/2,i.friendly=n,H(X,i),le.push(i),++f.bulletsFired},fi=(e,t,o,s,n)=>{const i=ie();i.position=e,i.rotation=t,i.velocity=o,i.angularVelocity=s,i.mass=ro,i.radius=5,i.targets=n,i.progress=0,i.currentTarget=0,vs(i),ks(i),H(Y,i),de.push(i),fo({x:-5,y:0},Math.PI/2,i),++f.rocketsFired},yi=(e,t,o,s)=>{l=ie(),l.position=e,l.rotation=t,l.velocity=o,l.angularVelocity=s,l.mass=Xn,l.drag=1,l.maxVelocity=.5,l.collider=yt?K:he,l.height=40,l.width=40,l.radius=l.width/2,l.maxHp=5,ue&&(l.maxHp=1),l.hp=l.maxHp,l.invincible=0,xt(l,Ks,l.height,l.width),H(De,l),Ct({x:-5,y:18},0,xe,Zs,l),Ct({x:-5,y:-18},0,xe,Qs,l)},Ct=(e,t,o,s,n)=>{const i=ie();i.position=e,i.rotation=t,i.parent=n,i.height=20,i.width=20,H(o,i),xt(i,s,i.height,i.width),n.children??(n.children=n.children||[]),n.children.push(i),fo({x:-5,y:0},Math.PI/2,i)},fo=(e,t,o)=>{const s=ie();s.position=e,s.rotation=t,s.parent=o,s.height=10,s.width=5,o.children??(o.children=o.children||[]),o.children.push(s),H(Me,s),xi({x:0,y:0},0,s)},xi=(e,t,o)=>{const s=ie();s.position=e,s.rotation=t,s.parent=o,s.height=5,s.width=5,o.children??(o.children=o.children||[]),o.children.push(s),H(Ke,s)},wi=(e,t,o,s,n)=>{if(ue&&["health"].includes(e))return;const i=ie();i.type=e,i.position=t,i.rotation=o,i.velocity=s,i.angularVelocity=n,i.width=50,i.height=50,i.collider=K,H(Je,i),Pe.push(i)},yo=()=>{k=!k,k?(io(),Ze(0)):je()},vi=()=>{if(l){q(De,l.id);for(let e of l.children){q(xe,e.id);for(let t of e.children)q(Me,t.id)}}},Mi=()=>{B.width=B.clientWidth,B.height=B.clientHeight,yi({x:B.width/2,y:B.height/2},0,{x:0,y:0},0),jn(ue?1:5)},bi=()=>{Mi(),co(),ft=requestAnimationFrame(ho)},ki=()=>{if(k)return;k=!0,cancelAnimationFrame(ft),Ze(0),l=null;const e=Qt(!ne,!R,me,ue);Wn(ne,R,me,ue,f,e),qn(),Ns(!ne,!R,me,ue)},Ti=()=>{ze=performance.now(),$=ze,Xe=$,ut=$,lt=$,dt=$,ht=$,As(),ns(),V=[],le=[],de=[],mt=1e3,Ye=3,re=1,pt(5),je(),ct()},xt=(e,t,o,s)=>{const n=new Image;n.src=t,n.onload=()=>{const i=document.createElement("canvas");i.width=s,i.height=o,i.getContext("2d").drawImage(n,0,0,s,o),e.texture=i,e.textureReady=!0}},Ei=(e,t)=>{for(let o=0;o<e.length;o++){const s=e[o],n=t.position,i={x:n.x+Math.random(),y:n.y+Math.random()},d=Yt(),c=t.rotation,m={x:d.x-i.x,y:d.y-i.y},u=Math.sqrt(m.x**2+m.y**2);u>0&&(m.x/=u,m.y/=u),m.x*=Math.random()*.1+.1,m.y*=Math.random()*.1+.1,me&&(m.x*=2,m.y*=2);const g=rt(5e-4),h=Math.max(s.width,s.height)/2;go(i,c,{x:0,y:0},m,g,h,"default",s,!0,s.width,s.height)}},Ii=e=>{ao=e},fe=(e,t,o,s,n)=>{if(uo)H(Ne,{a:e,b:t,collisionPoint:o,normal:s,lifetime:100});else{const i={position:o,rotation:Math.random()*Math.PI*2};H(Se,i),setTimeout(()=>q(Se,i.id),100)}};di();
